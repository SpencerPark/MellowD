<!DOCTYPE html>

<html>
<head>
  <title>Mellow D Parser</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="..\..\..\docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <div class="toctop" onclick="">
            <a class="source" href="..\..\..\index.html">Home</a>
            <h3>Table of Contents</h3>
              
                    
                    <div class="toc" onclick="">
                        <h3>src\main\antlr</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="MellowDLexer.html">
                                    MellowDLexer.g4
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="MellowDParser.html">
                                    MellowDParser.g4
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\ArticulatedSound.html">
                                    ArticulatedSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\Articulation.html">
                                    Articulation.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\Beat.html">
                                    Beat.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\Dynamic.html">
                                    Dynamic.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\Pitch.html">
                                    Pitch.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\PlayableSound.html">
                                    PlayableSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\TimingEnvironment.html">
                                    TimingEnvironment.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\compiler</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\compiler\Compiler.html">
                                    Compiler.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\compiler\SequencePlayer.html">
                                    SequencePlayer.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\midi</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\midi\GeneralMidiConstants.html">
                                    GeneralMidiConstants.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\midi\GeneralMidiInstrument.html">
                                    GeneralMidiInstrument.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\midi\GeneralMidiPercussion.html">
                                    GeneralMidiPercussion.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\midi\MidiNoteMessageSource.html">
                                    MidiNoteMessageSource.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\parser</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\Block.html">
                                    Block.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\BlockOptions.html">
                                    BlockOptions.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\IncorrectTypeException.html">
                                    IncorrectTypeException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\ParseException.html">
                                    ParseException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\SymbolTable.html">
                                    SymbolTable.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\TrackManager.html">
                                    TrackManager.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\UndefinedReferenceException.html">
                                    UndefinedReferenceException.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\primitives</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\primitives\Chord.html">
                                    Chord.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\primitives\Melody.html">
                                    Melody.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\primitives\Phrase.html">
                                    Phrase.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\primitives\Rhythm.html">
                                    Rhythm.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\java\cas\cs4tb3\mellowd\ChordResolutionTest.html">
                                    ChordResolutionTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\java\cas\cs4tb3\mellowd\CompilerTest.html">
                                    CompilerTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\java\cas\cs4tb3\mellowd\ParserTest.html">
                                    ParserTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\java\cas\cs4tb3\mellowd\TestErrorListener.html">
                                    TestErrorListener.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\compilertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\compilertest\articulation.html">
                                    articulation.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\compilertest\percussion.html">
                                    percussion.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\compilertest\strangeChords.html">
                                    strangeChords.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\compilertest\strangeMelodies.html">
                                    strangeMelodies.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\compilertest\strangeRhythms.html">
                                    strangeRhythms.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\compilertest\varDeclarations.html">
                                    varDeclarations.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\parsertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\parsertest\chordNames.html">
                                    chordNames.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\parsertest\simpleBlock.html">
                                    simpleBlock.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\parsertest\varDeclaration.html">
                                    varDeclaration.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\testdata</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\testdata\CompilerTestData.html">
                                    CompilerTestData.json
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\resources\testdata\ParserTestData.html">
                                    ParserTestData.json
                                </a>
                            </li>
                        
                        </div>
                    
          </div>
        
            
            <!-- Moved TOC above header -->
            
          
          <h1 id="mellow-d-parser">Mellow D Parser</h1>

          
            <div class='highlight'><pre>
parser grammar MellowDParser;</pre></div>
          
        
      </div>

      
        
        <p>Import the token vocabulary described by the <a href="MellowDLexer.html"><em>MellowD Lexer</em></a></p>

        
          <div class='highlight'><pre>options {
	tokenVocab = MellowDLexer;
}</pre></div>
        
      
        
        <p>Declare all of the imports needed. These go in the class header</p>

        
          <div class='highlight'><pre><span class="hljs-meta">@header</span> {
    <span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.*;
    <span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.midi.*;
    <span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.primitives.*;
    <span class="hljs-keyword">import</span> javax.sound.midi.*;
    <span class="hljs-keyword">import</span> java.util.*;
}</pre></div>
        
      
        
        <p>The <code>@members</code> block declares code that should be defined inside the generated parser class.</p>

        
          <div class='highlight'><pre><span class="hljs-meta">@members</span> {</pre></div>
        
      
        
        <p>The evaluation of everything depends on <a href="BlockOptions.html">BlockOptions</a> and the global
options will serve as the options for variable evaluation.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> BlockOptions globalOptions = <span class="hljs-keyword">new</span> BlockOptions();</pre></div>
        
      
        
        <p>The symbol table will be a reference table for all variable declarations</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> SymbolTable symbolTable = <span class="hljs-keyword">new</span> SymbolTable();</pre></div>
        
      
        
        <p>The timing environment is described in the compiler arguments and dictates the duration
of notes.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> TimingEnvironment timingEnv;</pre></div>
        
      
        
        <p>The entire goal of the compiler is to build this <code>midiSequence</code>. This sequence stores the actual
MIDI data.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> Sequence midiSequence;</pre></div>
        
      
        
        <p>The track manager is mainly used to instantiate <a href="Block.html">blocks</a> but also manages these
blocks which wrap a MIDI track.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> TrackManager trackManager;</pre></div>
        
      
        
        <p>An additional constructor (the default should not be used but we can’t get rid of it)</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MellowDParser</span><span class="hljs-params">(TokenStream inputStream, TimingEnvironment timingEnv, TrackManager trackManager)</span> </span>{
        <span class="hljs-keyword">this</span>(inputStream);
        <span class="hljs-keyword">this</span>.timingEnv = timingEnv;
        <span class="hljs-keyword">this</span>.trackManager = trackManager;
        <span class="hljs-keyword">this</span>.midiSequence = timingEnv.createSequence();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> BlockOptions <span class="hljs-title">getGlobalOptions</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.globalOptions;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Sequence <span class="hljs-title">getSequence</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.midiSequence;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOctaveShiftRequired</span><span class="hljs-params">(<span class="hljs-keyword">int</span> target)</span> </span>{
        <span class="hljs-keyword">return</span> target - <span class="hljs-keyword">this</span>.globalOptions.getOctave();
    }</pre></div>
        
      
        
        <p><a href="../primitives/Chord.html">Chords</a> are resolved differently then a direct symbol table lookup.
There are a standard set of names for chords and we want to lookup these names as if they
exist in the symbol table without actually putting them in there.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">private</span> Chord <span class="hljs-title">lookupChord</span><span class="hljs-params">(Token identifier, <span class="hljs-keyword">int</span> octave)</span> </span>{</pre></div>
        
      
        
        <p>Preforming a type check will throw an exception if the identifier is defined for something
other than a chord. This means if the identifier is defined as a chord or is undefined
the program will continue.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">this</span>.symbolTable.checkType(identifier, Chord.class);</pre></div>
        
      
        
        <p>The value in the table is pulled out of the table. If this value is not null then
a chord definition exists so we can simply put it in the correct octave and return it.</p>

        
          <div class='highlight'><pre>        Chord chord = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValue(identifier.getText(), Chord.class);
        <span class="hljs-keyword">if</span> (chord != <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> chord.shiftOctave(<span class="hljs-keyword">this</span>.getOctaveShiftRequired(octave));</pre></div>
        
      
        
        <p>Otherwise the reference is not defined in the symbol table so try to resolve one of the
default chords based on the name.</p>

        
          <div class='highlight'><pre>        chord = Chord.resolve(identifier.getText(), octave);</pre></div>
        
      
        
        <p>If the chord is still null then it could not be resolved and we should therefor throw
an undefined reference exception.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (chord == <span class="hljs-keyword">null</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndefinedReferenceException(identifier, <span class="hljs-string">"Identifier ("</span>+identifier.getText()+<span class="hljs-string">") is undefined."</span>);</pre></div>
        
      
        
        <p>Otherwise the resolution was successful and the chord can be returned.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">return</span> chord;
    }</pre></div>
        
      
        
        <p><a href="../primitives/Melody.html">Melody</a> concatenation may be spimply adding a single note to the end of
the sequence or looking up a pointer to a melody and adding the entire melody to the root.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">appendToMelody</span><span class="hljs-params">(Melody root, BlockOptions context, MidiNoteMessageSource notes, Token identifier, Articulation articulation)</span> </span>{</pre></div>
        
      
        
        <p>Although the approach is not very clean, this method assumes that <code>notes == null</code> &rarr; <code>identifier != null</code>. This allows
this method to control how to resolve the code to add.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (notes == <span class="hljs-keyword">null</span>) {</pre></div>
        
      
        
        <p>The notes are null so try and lookup the data pointed to by the identifier. If the type
of the pointer is a melody then get the data and append it to the root.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.symbolTable.identifierTypeIs(identifier.getText(), Melody.class)) {
                Melody mel = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValue(identifier.getText(), Melody.class).shiftOctave(<span class="hljs-keyword">this</span>.getOctaveShiftRequired(context.getOctave()));
                root.add(mel);</pre></div>
        
      
        
        <p>Otherwise attempt to resolve the identifier as a chord and add the chord as a single sound.</p>

        
          <div class='highlight'><pre>            } <span class="hljs-keyword">else</span> {
                Chord chord = lookupChord(identifier, context.getOctave());
                root.add(<span class="hljs-keyword">new</span> ArticulatedSound(chord, articulation));
            }</pre></div>
        
      
        
        <p>If the notes are not null then we have the simple case of appending a single sound
to the end of the root melody.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {
            root.add(<span class="hljs-keyword">new</span> ArticulatedSound(notes, articulation));
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> GeneralMidiPercussion <span class="hljs-title">resolvePercussionID</span><span class="hljs-params">(Token identifier, Token indexNum)</span> </span>{
        GeneralMidiPercussion drumSound = GeneralMidiPercussion.lookup(identifier.getText());</pre></div>
        
      
        
        <p>If the sound is not null then it was successfully resolved.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (drumSound != <span class="hljs-keyword">null</span>) {</pre></div>
        
      
        
        <p>If NUMBER is not null and the percussion sound was resolved we have a semantic
issue. A single sound cannot be indexed.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> (indexNum != <span class="hljs-keyword">null</span>)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException(indexNum, <span class="hljs-string">"Cannot index a percussion sound."</span>);
        }
        <span class="hljs-keyword">return</span> drumSound;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> MidiNoteMessageSource <span class="hljs-title">resolveChordID</span><span class="hljs-params">(Token identifier, Token indexNum, <span class="hljs-keyword">int</span> octave)</span> </span>{
        Chord chord = lookupChord(identifier, octave);</pre></div>
        
      
        
        <p>If the indexNum is null there is no indexing and we can return the chord.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (indexNum == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">return</span> chord;</pre></div>
        
      
        
        <p>Otherwise attempt to pull a single pitch out of the chord.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {</pre></div>
        
      
        
        <p>The indexNum is a valid int because the pattern
that is must match to become the NUMBER token is an int description.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">int</span> index = Integer.parseInt(indexNum.getText());
            <span class="hljs-keyword">if</span> (index &gt; chord.size())
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException(identifier, <span class="hljs-string">"Index "</span>+index+<span class="hljs-string">" is larger than the chord size of "</span>+chord.size());
            <span class="hljs-keyword">return</span> chord.getPitch(index);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">resolveChordParamID</span><span class="hljs-params">(List&lt;Pitch&gt; pitches, Token identifier, Token indexNum, <span class="hljs-keyword">int</span> octave, <span class="hljs-keyword">boolean</span> percussion)</span> </span>{</pre></div>
        
      
        
        <p>If inside a percussion block, first attempt to resolve the identifier as the
name of a percussion sound.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (percussion) {
            GeneralMidiPercussion drumSound = resolvePercussionID(identifier, indexNum);
            <span class="hljs-keyword">if</span> (drumSound != <span class="hljs-keyword">null</span>) {
                pitches.add(drumSound.getAsPitch());
                <span class="hljs-keyword">return</span>;
            }
        }</pre></div>
        
      
        
        <p>If pitches is still null then it was not resolved to a percussion sound. Now whether
or not we are in a percussion block the next step is to try and resolve a chord from
the identifier.</p>

        
          <div class='highlight'><pre>        MidiNoteMessageSource noteSource = resolveChordID(identifier, indexNum, octave);
        <span class="hljs-keyword">if</span> (noteSource <span class="hljs-keyword">instanceof</span> Chord) pitches.addAll(((Chord) noteSource).getPitches());
        <span class="hljs-keyword">else</span>                             pitches.add((Pitch) noteSource);
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">resolveMelodyParamID</span><span class="hljs-params">(Melody root, Token identifier, Token indexNum, Articulation art, <span class="hljs-keyword">int</span> octave, <span class="hljs-keyword">boolean</span> percussion)</span> </span>{</pre></div>
        
      
        
        <p>If inside a percussion block, first attempt to resolve the identifier as the
name of a percussion sound.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (percussion) {
            GeneralMidiPercussion drumSound = resolvePercussionID(identifier, indexNum);
            <span class="hljs-keyword">if</span> (drumSound != <span class="hljs-keyword">null</span>) {
                root.add(<span class="hljs-keyword">new</span> ArticulatedSound(drumSound.getAsPitch(), art));
                <span class="hljs-keyword">return</span>;
            }
        }</pre></div>
        
      
        
        <p>A percussion sound was not resolved so try and lookup the data pointed to by the identifier.
If the type of the pointer is a melody then get the data and append it to the root.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.symbolTable.identifierTypeIs(identifier.getText(), Melody.class)) {
            Melody mel = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValue(identifier.getText(), Melody.class);
            mel = mel.shiftOctave(<span class="hljs-keyword">this</span>.getOctaveShiftRequired(octave));
            root.add(mel);
            <span class="hljs-keyword">if</span> (art != Articulation.NONE)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IncorrectTypeException(identifier, <span class="hljs-string">"Cannot articulate a melody with "</span>+art.name().toLowerCase());</pre></div>
        
      
        
        <p>Otherwise attempt to resolve the identifier as a chord and add the chord as a single sound.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {
            MidiNoteMessageSource noteSource = resolveChordID(identifier, indexNum, octave);
            root.add(<span class="hljs-keyword">new</span> ArticulatedSound(noteSource, art));
        }
    }
}</pre></div>
        
      
        
        <p>Begin defining the parser rules.</p>

        
      
        
        <p>An octaveShift moves the note up or down an number of octaves. It matches the
pattern for a java integer so the string matched by this rule can be passed directly
into <code>Integer.parseInt</code> and doesn’t need to return anything.</p>

        
          <div class='highlight'><pre>octaveShift
    : ( PLUS | MINUS ) NUMBER;</pre></div>
        
      
        
        <p>Articulation is a single articulation character. This rule returns the described
<a href="../primitives/Articulation.html">Articulation</a></p>

        
          <div class='highlight'><pre>articulation
returns [Articulation art]
    : DOT           {$art = Articulation.STACCATO;      }
    | EXCLAMATION   {$art = Articulation.STACCATISSIMO; }
    | HAT           {$art = Articulation.MARCATO;       }
    | BACK_TICK     {$art = Articulation.ACCENT;        }
    | USCORE        {$art = Articulation.TENUTO;        }
    | TILDA         {$art = Articulation.GLISCANDO;     }
    ;</pre></div>
        
      
        
        <p>A noteChar is a single lowercase letter from <code>A</code> to <code>G</code> that describes a ptich. This
pitch is different depending on the octave so the resolution requires some <a href="BlockOptions.html">BlockOptions</a>
to obtain the octave for the current context.</p>

        
          <div class='highlight'><pre>noteChar[BlockOptions options]
returns [Pitch pitch]
    : A     {$pitch = Pitch.A.inOctave($options.getOctave());}
    | B     {$pitch = Pitch.B.inOctave($options.getOctave());}
    | C     {$pitch = Pitch.C.inOctave($options.getOctave());}
    | D     {$pitch = Pitch.D.inOctave($options.getOctave());}
    | E     {$pitch = Pitch.E.inOctave($options.getOctave());}
    | F     {$pitch = Pitch.F.inOctave($options.getOctave());}
    | G     {$pitch = Pitch.G.inOctave($options.getOctave());}
    ;</pre></div>
        
      
        
        <p>A noteDef fully describes a pitch. It consists of a <code>noteChar</code> optionally followed by a
sharp or flat symbol and an optional <code>octaveShift</code>. This is the top level pitch resolution
rule.</p>

        
          <div class='highlight'><pre>noteDef[BlockOptions options]
returns [Pitch pitch]
    :   ( noteChar[$options]    {$pitch = $noteChar.pitch;}
            (   SHARP           {$pitch = $pitch.sharp(); }
            |   FLAT            {$pitch = $pitch.flat();  }
            )?
            ( octaveShift {$pitch = $pitch.shiftOctave(Integer.parseInt($octaveShift.text));} )?
        )
    ;</pre></div>
        
      
        
        <p>A <code>chord</code> definition is one or more <code>chordParam</code>s between <code>(</code> and <code>)</code> seperated by commas. A chord
can be articulated which is the equivalent of articulating each pitch in the chord with the articulation.
No individual note articulation is accepted.</p>

        
          <div class='highlight'><pre>chord[BlockOptions options]
returns [ArticulatedSound sound]
locals [List&lt;Pitch&gt; pitches = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;()]
    :   PAREN_OPEN
        chordParam[$options, $pitches] ( COMMA chordParam[$options, $pitches] )*
        PAREN_CLOSE {$sound = <span class="hljs-keyword">new</span> ArticulatedSound(<span class="hljs-keyword">new</span> Chord($pitches));}
        ( articulation {$sound.setArticulation($articulation.art);} )?
    ;</pre></div>
        
      
        
        <p>A chord param can be a note or a pointer to another chord that is optionally indexed.
As this param may consist of multiple pitches the rule returns a list of
pitches. Chord may be indexed for their individual pitches so the order of the pitches is important
and the list is the collection required to accomplish this.</p>

        
          <div class='highlight'><pre>chordParam[BlockOptions options, List&lt;Pitch&gt; pitches]
    :   noteDef[$options]
            { $pitches.add($noteDef.pitch); }
    |   IDENTIFIER ( COLON NUMBER )?
            { resolveChordParamID($pitches, $IDENTIFIER, $NUMBER, $options.getOctave(),
                $options.isPercussion()); }
    ;</pre></div>
        
      
        
        <p>A <code>melody</code> is made up of 1 or more <code>melodyParam</code>s seperated by a comma. Each melodyParam is
responsible for appending itself to the melody. The melody definition begins with a <code>[</code>
and ends with a <code>]</code>.</p>

        
          <div class='highlight'><pre>melody[BlockOptions options]
returns [Melody mel = <span class="hljs-keyword">new</span> Melody(<span class="hljs-keyword">new</span> LinkedList&lt;ArticulatedSound&gt;())]
    :   BRACKET_OPEN
        melodyParam[$mel, $options] ( COMMA melodyParam[$mel, $options] )*
        BRACKET_CLOSE
    ;</pre></div>
        
      
        
        <p>Each melody parameter is an articulated note, a chord, a pointer to a melody or chord,
or a STAR for a rest. Depending on the option matched this rule may add one or many sounds to the
melody. The <code>*</code> star character representing a rest.</p>

        
          <div class='highlight'><pre>melodyParam[Melody mel, BlockOptions options]
locals [Articulation art = Articulation.NONE]
    :   noteDef[$options] ( articulation {$art = $articulation.art;} )?
            { $mel.add(<span class="hljs-keyword">new</span> ArticulatedSound($noteDef.pitch, $art)); }
    |   IDENTIFIER ( COLON NUMBER )? ( articulation {$art = $articulation.art;})?
            { <span class="hljs-keyword">this</span>.resolveMelodyParamID($mel, $IDENTIFIER, $NUMBER, $art, $options.getOctave(),
                $options.isPercussion()); }
    |   chord[$options]
            { $mel.add($chord.sound); }
    |   STAR
            { $mel.add(<span class="hljs-keyword">new</span> ArticulatedSound(Pitch.REST)); }
    ;</pre></div>
        
      
        
        <p>A rhythm char is a single char that is the irst letter of the beat duration it is
describing. The supported durations are whole, half, quarter, eight, sizteenth and
thirty-second notes.</p>

        
          <div class='highlight'><pre>rhythmChar
returns [Beat beat]
    : W {$beat = Beat.WHOLE;        }
    | H {$beat = Beat.HALF;         }
    | Q {$beat = Beat.QUARTER;      }
    | E {$beat = Beat.EIGHTH;       }
    | S {$beat = Beat.SIXTEENTH;    }
    | T {$beat = Beat.THIRTYSECOND; }
    ;</pre></div>
        
      
        
        <p>A rhythmDef is the building block of a rhythm. It is a rhythm char followed by 0 or more <code>.</code>. Each
dot extends the duration of the beat by half its value. This extension uses the previously
added value in the calculation. Ex: <code>h..</code> is <sup>1</sup>&frasl;<sub>2</sub> + <sup>1</sup>&frasl;<sub>4</sub> + <sup>1</sup>&frasl;<sub>8</sub></p>

        
          <div class='highlight'><pre>rhythmDef
returns [Beat beat]
    : rhythmChar ( DOT )* {$beat = $DOT == <span class="hljs-keyword">null</span> ? $rhythmChar.beat : $rhythmChar.beat.dot($DOT.text.length());};</pre></div>
        
      
        
        <p><code>rhythm</code> is the top level rhythm rule. It is a list of <code>rhythmParam</code>‘s seperated by a comma opening
with a <code>&lt;</code> and closed with <code>&gt;</code>. By default the <code>rhythmParam</code>‘s inside this definition is
not slurred, hence slur=false is passed into the rule call.</p>

        
          <div class='highlight'><pre>rhythm
returns [Rhythm rhy = <span class="hljs-keyword">new</span> Rhythm()]
    : P_BRACKET_OPEN rhythmParam[$rhy, <span class="hljs-keyword">false</span>] ( COMMA rhythmParam[$rhy, <span class="hljs-keyword">false</span>] )* P_BRACKET_CLOSE ;</pre></div>
        
      
        
        <p>A slurred rhythm is a regular rhythm inside <code>(</code> and <code>)</code>. It makes the melody glide over
the rhythm without as distinct of a break as regular note performances. It looks the same as
<code>rhythm</code> passing slur=true into the <code>rhythmParam</code> rule.</p>

        
          <div class='highlight'><pre>slurredRhythm[Rhythm rhy]
    : PAREN_OPEN rhythmParam[$rhy, <span class="hljs-keyword">true</span>] ( COMMA rhythmParam[$rhy, <span class="hljs-keyword">true</span>] )* PAREN_CLOSE ;</pre></div>
        
      
        
        <p>A tuplet is a duration modification. The common tuplet being a triplet. A quarter note triplet
performs 3 quarter notes in the same time that normally takes 2. A <code>5:3</code> quarter note tuplet
performs 5 quarter notes in the time it takes to perform 3. If the second number in the ratio
is not given it is assumed to be 1 less than the first. As such a numerator of [0, 1] or a
denominator of [0] do not make any sense in this context.</p>

        
      
        
        <p>To slur the notes in the tuplet the <code>rhythmDef</code> is wrapped in <code>(</code> and <code>)</code>. Each tuplet can only consist
of beats of the same duration so there is no reason to write the beat out multiple times. It is
therefore only written once but adds <code>num</code> beats to the rhythm.</p>

        
          <div class='highlight'><pre>tuplet[Rhythm rhy]
    : num=NUMBER ( COLON div=NUMBER )?
        ( PAREN_OPEN rhythmDef PAREN_CLOSE
        | rhythmDef
        )
        {</pre></div>
        
      
        
        <p>Check the preconditions on the num and div</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> ($num.<span class="hljs-keyword">int</span> == <span class="hljs-number">0</span>)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($num, <span class="hljs-string">"Tuplet number must be greater than 0"</span>);
            <span class="hljs-keyword">if</span> ($div != <span class="hljs-keyword">null</span> &amp;&amp; $div.<span class="hljs-keyword">int</span> == <span class="hljs-number">0</span>)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($div, <span class="hljs-string">"Tuplet division cannot be 0"</span>);</pre></div>
        
      
        
        <p>If the PAREN_OPEN is present then the tuplet is slurred</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">boolean</span> slur = $PAREN_OPEN != <span class="hljs-keyword">null</span>;</pre></div>
        
      
        
        <p>Expand the beat to the number of beats in the numerator</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; $num.<span class="hljs-keyword">int</span>; i++) {
                Beat beat;</pre></div>
        
      
        
        <p>If the division is present use it in the duration calculation</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">if</span> ($div != <span class="hljs-keyword">null</span>)
                    beat = $rhythmDef.beat.tuplet($num.<span class="hljs-keyword">int</span>, $div.<span class="hljs-keyword">int</span>);</pre></div>
        
      
        
        <p>Otherwise use the default (num only) duration calculation</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">else</span>
                    beat = $rhythmDef.beat.tuplet($num.<span class="hljs-keyword">int</span>);</pre></div>
        
      
        
        <p>Append the beat to the rhythm</p>

        
          <div class='highlight'><pre>                rhy.append(beat, slur);
            }
        }
    ;</pre></div>
        
      
        
        <p>A <code>rhythmParam</code> takes any rhythm parameter and appends the appropriate beats to the rhythm it
belongs to. The <code>slur</code> argument specifies if this parameter is slurred or not. Each option
in this rule appends the appropriate beats to the rhythm.</p>

        
          <div class='highlight'><pre>rhythmParam[Rhythm rhy, <span class="hljs-keyword">boolean</span> slur]
    :   rhythmDef     { $rhy.append($rhythmDef.beat, $slur); }
    |   IDENTIFIER    {
                        Rhythm value = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValueOrThrow($IDENTIFIER, Rhythm.class);
                        $rhy.append(value, $slur);
                      }
    |   slurredRhythm[$rhy]
    |   tuplet[$rhy]
    ;</pre></div>
        
      
        
        <p>A variable declaration maps an identifier to a primitive. These primitives include <a href="../primitives/Chord.html">Chord</a>
, <a href="../primitives/Melody.html">Melody</a>, <a href="../primitives/Rhythm.html">Rhythm</a> and <a href="../primitives/Phrase.html">Phrase</a>.
Each mapping is put into the compiler’s symbol table. Adding a <code>*</code> after the assignment token
parses the value as if it was inside a percussion block.</p>

        
          <div class='highlight'><pre>varDeclaration
locals [<span class="hljs-keyword">boolean</span> wasPercussion]
<span class="hljs-meta">@init</span>  {$wasPercussion = <span class="hljs-keyword">this</span>.globalOptions.isPercussion();}
    : id=<span class="hljs-function">IDENTIFIER <span class="hljs-title">ASSIGNMENT</span> <span class="hljs-params">( STAR {<span class="hljs-keyword">this</span>.globalOptions.setPercussion(<span class="hljs-keyword">true</span>)</span></span>;} )?
                                ( ref=IDENTIFIER                {
                                                                    Object val = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValue($ref.text, Object.class);
                                                                    <span class="hljs-keyword">if</span> (val != <span class="hljs-keyword">null</span>)
                                                                        <span class="hljs-keyword">this</span>.symbolTable.addDeclaration($id.text, val);
                                                                    <span class="hljs-keyword">else</span>
                                                                        <span class="hljs-keyword">this</span>.symbolTable.addDeclaration($id.text, lookupChord($ref, <span class="hljs-keyword">this</span>.globalOptions.getOctave()));
                                                                }
                                | chord [<span class="hljs-keyword">this</span>.globalOptions]    {<span class="hljs-keyword">this</span>.symbolTable.addDeclaration($id.text, $chord.sound.getSound());}
                                | melody[<span class="hljs-keyword">this</span>.globalOptions]    {<span class="hljs-keyword">this</span>.symbolTable.addDeclaration($id.text, $melody.mel);}
                                | rhythm                        {<span class="hljs-keyword">this</span>.symbolTable.addDeclaration($id.text, $rhythm.rhy);}
                                | phrase[<span class="hljs-keyword">this</span>.globalOptions]    {<span class="hljs-keyword">this</span>.symbolTable.addDeclaration($id.text, $phrase.phr);}
                                ) {<span class="hljs-keyword">this</span>.globalOptions.setPercussion($wasPercussion);}
    ;</pre></div>
        
      
        
        <p>Dynamics are what change the velocity of a note. Mellow D supports the main dynamic identifiers
with <code>pppp</code> being the quietest and <code>ffff</code> being the loundest.</p>

        
          <div class='highlight'><pre>dynamicDeclaration
returns [Dynamic dynamic]
    : PPPP  {$dynamic = Dynamic.pppp;}
    | PPP   {$dynamic = Dynamic.ppp; }
    | PP    {$dynamic = Dynamic.pp;  }
    | P     {$dynamic = Dynamic.p;   }
    | MP    {$dynamic = Dynamic.mp;  }
    | MF    {$dynamic = Dynamic.mf;  }
    | F     {$dynamic = Dynamic.f;   }
    | FF    {$dynamic = Dynamic.ff;  }
    | FFF   {$dynamic = Dynamic.fff; }
    | FFFF  {$dynamic = Dynamic.ffff;}
    ;</pre></div>
        
      
        
        <p>Block options are the configuration for the block. They appear after a block identifier inbetween
<code>[</code> and <code>]</code>. Each configuration option is either a property option or a flag option. The entire
configuration is a comma seperated list of these options.</p>

        
          <div class='highlight'><pre>blockOptions[BlockOptions options]
    : BRACKET_OPEN ( ( propertyOption[$options] | flagOption[$options] ) ( COMMA ( propertyOption[$options] | flagOption[$options] ) )* )? BRACKET_CLOSE;</pre></div>
        
      
        
        <p>The first option type is a property option. This option assigns a value to a key. The value can
be an identifier or a number.</p>

        
          <div class='highlight'><pre>propertyOption[BlockOptions options]
    : key=<span class="hljs-function">IDENTIFIER <span class="hljs-title">ASSIGNMENT</span> <span class="hljs-params">( valueID=IDENTIFIER | valueNum=NUMBER )</span>
        </span>{   <span class="hljs-keyword">switch</span>($key.text.toLowerCase()) {</pre></div>
        
      
        
        <p>An instrument name or MIDI number can be specified to change the instrument
for this block.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">case</span> <span class="hljs-string">"instrument"</span>:
                    <span class="hljs-keyword">if</span> ($valueID != <span class="hljs-keyword">null</span>) {
                        $options.setInstrument($valueID);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">int</span> inst = $valueNum.<span class="hljs-keyword">int</span>;
                        <span class="hljs-keyword">if</span> (inst &gt; <span class="hljs-number">127</span>)
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueNum, <span class="hljs-string">"Instrument code must be less than 128."</span>);
                        $options.setInstrument(inst);
                    }
                    <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>A soundbank can only be given by MIDI number. This option is not used in the majority
of cases but allows support for custom synthesiser banks</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">case</span> <span class="hljs-string">"soundbank"</span>:
                    <span class="hljs-keyword">if</span> ($valueNum == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueID, <span class="hljs-string">"Expected a soundbank id but found "</span>+$valueID.text);
                    $options.setSoundbank($valueNum.<span class="hljs-keyword">int</span>);
                    <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>The octave is the base octave for the block. All declarations inside a block are
relative to this octave. As an octave is a number, an identifier is not an
acceptable.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">case</span> <span class="hljs-string">"octave"</span>:
                    <span class="hljs-keyword">if</span> ($valueNum == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueID, <span class="hljs-string">"Expected octave number but found "</span>+$valueID.text);
                    <span class="hljs-keyword">int</span> octave = $valueNum.<span class="hljs-keyword">int</span>;
                    <span class="hljs-keyword">if</span> (octave &gt; <span class="hljs-number">10</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueNum, <span class="hljs-string">"Octave is too high. 10 is highest byt found "</span>+octave);
                    $options.setOctave(octave);
                    <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>Loop or repeat specifies how many times to repeat the contents of the block
in the compiled song.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">case</span> <span class="hljs-string">"loop"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"repeat"</span>:
                    <span class="hljs-keyword">if</span> ($valueNum == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueID, <span class="hljs-string">"Expected a loop count but found "</span>+$valueID.text);
                    $options.setLoopCount($valueNum.<span class="hljs-keyword">int</span>);
                    <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>onchannel, samechannelas, sharechannel are all ways to say that this block should
operate on the same channel as another block by the given name. As all block names
are identifiers it does not make sense for this value to be a number.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">case</span> <span class="hljs-string">"onchannel"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"samechannelas"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"sharechannel"</span>:
                    <span class="hljs-keyword">if</span> ($valueID == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueNum, <span class="hljs-string">"Expected the name of the block that this channel should share a channel with"</span>
                            + <span class="hljs-string">" but found "</span> + $valueNum.text);
                    $options.setShareChannel($valueID.text);
                    <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>channel is another option that is uncommon. It allows direct specification of the MIDI
channel number that this block should operate on. As it is a number, an identifier does
not make sense in this context.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">case</span> <span class="hljs-string">"channel"</span>:
                    <span class="hljs-keyword">if</span> ($valueNum == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueID, <span class="hljs-string">"Expected the number of the MIDI channel to requests but"</span>
                            + <span class="hljs-string">" found "</span> + $valueID.text);
                    $options.setChannel($valueNum.<span class="hljs-keyword">int</span>);
                    <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>If the key was not caught by another case it is an unknown option.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($key, <span class="hljs-string">"Unknow block option "</span> + $key.text + <span class="hljs-string">"."</span>);
            }
        }
    ;</pre></div>
        
      
        
        <p>A flag option is an on/off flag. If the flag exists it is in the on state. If it is prefixed
with <code>-</code> it is set to the off state.</p>

        
          <div class='highlight'><pre>flagOption[BlockOptions options]
    :   ( off=MINUS )? flag=IDENTIFIER
        {
            <span class="hljs-keyword">switch</span> ($flag.text.toLowerCase()) {</pre></div>
        
      
        
        <p>percussion or drums sets the block in percussion mode where it can accept
percussion sound names to describe pitches.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">case</span> <span class="hljs-string">"percussion"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"drums"</span>:
                    $options.setPercussion($off == <span class="hljs-keyword">null</span>);
                    <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>If none of the cases catch the flag then the option is undefined.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($flag, <span class="hljs-string">"Unknow block option "</span> + $flag.text + <span class="hljs-string">"."</span>);
            }
        }
    ;</pre></div>
        
      
        
        <p>Phrases are the finished product for a sequence of sounds. A phrase may be a pointer to a phrase
variable or a pitch definition <code>*</code> a rhythm. A pitch definition may be a melody, chord, or a pointer
to a melody or chord. The rhythm may be a direct rhythm declaration or a pointer to a rhythm.</p>

        
          <div class='highlight'><pre>phrase[BlockOptions options]
returns [Phrase phr]
locals [Melody mel]
    :   (   ( melody[$options]  {$mel = $melody.mel;}
            | chord[$options]   {$mel = <span class="hljs-keyword">new</span> Melody(Arrays.asList($chord.sound));}
            | IDENTIFIER articulation?
                            {</pre></div>
        
      
        
        <p>If the identifier points to a melody use it as the melody</p>

        
          <div class='highlight'><pre>                                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.symbolTable.identifierTypeIs($IDENTIFIER.getText(), Melody.class)) {
                                    $mel = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValue($IDENTIFIER.getText(), Melody.class).shiftOctave(<span class="hljs-keyword">this</span>.getOctaveShiftRequired($options.getOctave()));</pre></div>
        
      
        
        <p>A melody cannot be articulated so throw an exception if an articulation
was given.</p>

        
          <div class='highlight'><pre>                                    <span class="hljs-keyword">if</span> ($articulation.ctx != <span class="hljs-keyword">null</span>)
                                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IncorrectTypeException($IDENTIFIER, <span class="hljs-string">"Cannot articulate a melody."</span>);</pre></div>
        
      
        
        <p>Otherwise attempt to resolve a chord. This resolution will throw an exception
if it can’t be resolved.</p>

        
          <div class='highlight'><pre>                                } <span class="hljs-keyword">else</span> {
                                    Chord chord = lookupChord($IDENTIFIER, $options.getOctave());</pre></div>
        
      
        
        <p>Build a melody with a single element, the chord.</p>

        
          <div class='highlight'><pre>                                    List&lt;ArticulatedSound&gt; notes = Arrays.asList(<span class="hljs-keyword">new</span> ArticulatedSound(chord, $articulation.ctx == <span class="hljs-keyword">null</span> ? Articulation.NONE : $articulation.art));
                                    $mel = <span class="hljs-keyword">new</span> Melody(notes);
                                }
                            }
            )
            STAR
            ( rhythm {$phr = $rhythm.rhy.createPhrase($mel);}</pre></div>
        
      
        
        <p>Try to resolve the identifier as a rhythm and create a phrase from it</p>

        
          <div class='highlight'><pre>            | IDENTIFIER {$phr = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValueOrThrow($IDENTIFIER, Rhythm.class).createPhrase($mel);}
            )
        )
        |</pre></div>
        
      
        
        <p>The other option is to specify a variable name that points to a phrase</p>

        
          <div class='highlight'><pre>        ( IDENTIFIER {$phr = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValueOrThrow($IDENTIFIER, Phrase.class).shiftOctave(<span class="hljs-keyword">this</span>.getOctaveShiftRequired($options.getOctave()));} )
    ;</pre></div>
        
      
        
        <p>A block is a collection of phrases and dynamic declarations.</p>

        
          <div class='highlight'><pre>block
locals [Block b, BlockOptions options]</pre></div>
        
      
        
        <p>The first step is to lookup the block with the given name ($IDENTIFIER). If the block doesn’t exist
yet the block options used will be a copy of the global options. Otherwise the options will be
a copy of the block’s options.</p>

        
          <div class='highlight'><pre>    :   IDENTIFIER {$b = <span class="hljs-keyword">this</span>.trackManager.getBlock($IDENTIFIER.text); $options  = <span class="hljs-keyword">new</span> BlockOptions($b == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">this</span>.globalOptions : $b.getOptions());} blockOptions[$options]? BRACE_OPEN
            {</pre></div>
        
      
        
        <p>If the block is null it must be created now with the parsed block options.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">if</span> ($b == <span class="hljs-keyword">null</span>)
                    $b = <span class="hljs-keyword">this</span>.trackManager.createBlock($IDENTIFIER, <span class="hljs-keyword">this</span>.timingEnv, <span class="hljs-keyword">this</span>.midiSequence.createTrack(), $options);</pre></div>
        
      
        
        <p>Then enter the block</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">try</span> {
                    $b.enterBlock($IDENTIFIER, $options);
                } <span class="hljs-keyword">catch</span> (InvalidMidiDataException e) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($blockOptions.start, e.getMessage());
                }
            }</pre></div>
        
      
        
        <p>Now that we are inside the block we expect to see <code>dynamicDeclaration</code>s or a <code>phrase</code>s.</p>

        
          <div class='highlight'><pre>        (</pre></div>
        
      
        
        <p>A dynamic declaration sets the dynaic for the block it is currently inside. If it is
directly followed by a crescendo or decrescendo token then the block dynamic
is notified that the change to the next token shuld be gradual</p>

        
          <div class='highlight'><pre>            dynamicDeclaration  {
                                    <span class="hljs-keyword">try</span> {
                                        $b.setDynamic($dynamicDeclaration.dynamic);
                                    } <span class="hljs-keyword">catch</span> (InvalidMidiDataException e) {
                                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($dynamicDeclaration.start, e.getMessage());
                                    }
                                }
            ( DYNAMIC_CRES      {$b.crescendo($DYNAMIC_CRES);}
            | DYNAMIC_DECRES    {$b.decrescendo($DYNAMIC_DECRES);}
            )?</pre></div>
        
      
        
        <p>If a phrase is encountered it is added to the block which appends it to the track.</p>

        
          <div class='highlight'><pre>        | phrase[$options]    {
                                            <span class="hljs-keyword">try</span> {
                                                $b.addPhrase($phrase.phr);
                                            } <span class="hljs-keyword">catch</span> (InvalidMidiDataException e) {
                                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($dynamicDeclaration.start, e.getMessage());
                                            }
                                        }
        )*</pre></div>
        
      
        
        <p>When the block is closed with the closing <code>}</code> the block is notified that no more data will
be incoming in this fragment.</p>

        
          <div class='highlight'><pre>        BRACE_CLOSE {$b.leaveBlock();}
    ;</pre></div>
        
      
        
        <p>A song is the top level rule, the entry point for the parser. At the top level only
variable declarations or blocks can be defined. A song consists of any number of these
declarations.</p>

        
          <div class='highlight'><pre>song
    :   ( varDeclaration
        | block
        )*
        EOF {<span class="hljs-keyword">this</span>.trackManager.finish();}
    ;</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
