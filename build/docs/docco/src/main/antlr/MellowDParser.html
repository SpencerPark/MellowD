<!DOCTYPE html>

<html>
<head>
  <title>Mellow D Parser</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="..\..\..\docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <div class="toctop">
            <a class="source" href="..\..\..\index.html">Home</a>
            <h3>Table of Contents</h3>
              
                    
                    <div class="toc">
                        <h3>src\main\antlr</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="MellowDLexer.html">
                                    MellowDLexer.g4
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="MellowDParser.html">
                                    MellowDParser.g4
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc">
                        <h3>src\main\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\ArticulatedSound.html">
                                    ArticulatedSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\Articulation.html">
                                    Articulation.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\Beat.html">
                                    Beat.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\Dynamic.html">
                                    Dynamic.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\Pitch.html">
                                    Pitch.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\PlayableSound.html">
                                    PlayableSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\TimingEnvironment.html">
                                    TimingEnvironment.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc">
                        <h3>src\main\java\cas\cs4tb3\mellowd\compiler</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\compiler\Compiler.html">
                                    Compiler.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\compiler\SequencePlayer.html">
                                    SequencePlayer.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc">
                        <h3>src\main\java\cas\cs4tb3\mellowd\midi</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\midi\GeneralMidiConstants.html">
                                    GeneralMidiConstants.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\midi\GeneralMidiInstrument.html">
                                    GeneralMidiInstrument.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\midi\GeneralMidiPercussion.html">
                                    GeneralMidiPercussion.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\midi\MidiNoteMessageSource.html">
                                    MidiNoteMessageSource.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc">
                        <h3>src\main\java\cas\cs4tb3\mellowd\parser</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\Block.html">
                                    Block.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\BlockOptions.html">
                                    BlockOptions.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\IncorrectTypeException.html">
                                    IncorrectTypeException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\ParseException.html">
                                    ParseException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\SymbolTable.html">
                                    SymbolTable.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\TrackManager.html">
                                    TrackManager.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\parser\UndefinedReferenceException.html">
                                    UndefinedReferenceException.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc">
                        <h3>src\main\java\cas\cs4tb3\mellowd\primitives</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\primitives\Chord.html">
                                    Chord.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\primitives\Melody.html">
                                    Melody.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\primitives\Phrase.html">
                                    Phrase.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\java\cas\cs4tb3\mellowd\primitives\Rhythm.html">
                                    Rhythm.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc">
                        <h3>src\test\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\java\cas\cs4tb3\mellowd\ChordResolutionTest.html">
                                    ChordResolutionTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\java\cas\cs4tb3\mellowd\ParserTest.html">
                                    ParserTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\test\java\cas\cs4tb3\mellowd\TestErrorListener.html">
                                    TestErrorListener.java
                                </a>
                            </li>
                        
                        </div>
                    
          </div>
        
            
            <!-- Moved TOC above header -->
            
          
          <h1 id="mellow-d-parser">Mellow D Parser</h1>

          
            <div class='highlight'><pre>
parser grammar MellowDParser;</pre></div>
          
        
      </div>

      
        
        <p>Import the token vocabulary described by the <a href="MellowDLexer.html"><em>MellowD Lexer</em></a></p>

        
          <div class='highlight'><pre>options {
	tokenVocab = MellowDLexer;
}</pre></div>
        
      
        
        <p>imports</p>

        
          <div class='highlight'><pre><span class="hljs-meta">@header</span> {
    <span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.*;
    <span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.midi.*;
    <span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.primitives.*;
    <span class="hljs-keyword">import</span> javax.sound.midi.*;
    <span class="hljs-keyword">import</span> java.util.*;
}</pre></div>
        
      
        
        <p>methods and class body</p>

        
          <div class='highlight'><pre><span class="hljs-meta">@members</span> {
    <span class="hljs-keyword">private</span> BlockOptions globalOptions = <span class="hljs-keyword">new</span> BlockOptions();
    <span class="hljs-keyword">private</span> SymbolTable symbolTable = <span class="hljs-keyword">new</span> SymbolTable();
    <span class="hljs-keyword">private</span> TimingEnvironment timingEnv;
    <span class="hljs-keyword">private</span> Sequence midiSequence;
    <span class="hljs-keyword">private</span> TrackManager trackManager;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MellowDParser</span><span class="hljs-params">(TokenStream inputStream, TimingEnvironment timingEnv, TrackManager trackManager)</span> </span>{
        <span class="hljs-keyword">this</span>(inputStream);
        <span class="hljs-keyword">this</span>.timingEnv = timingEnv;
        <span class="hljs-keyword">this</span>.trackManager = trackManager;
        <span class="hljs-keyword">this</span>.midiSequence = timingEnv.createSequence();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> BlockOptions <span class="hljs-title">getGlobalOptions</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.globalOptions;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Sequence <span class="hljs-title">getSequence</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.midiSequence;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> Chord <span class="hljs-title">lookupChord</span><span class="hljs-params">(Token identifier, <span class="hljs-keyword">int</span> octave)</span> </span>{
        <span class="hljs-keyword">this</span>.symbolTable.checkType(identifier, Chord.class);

        Chord chord = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValue(identifier.getText(), Chord.class);
        <span class="hljs-keyword">if</span> (chord != <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> chord.inOctave(octave);

        chord = Chord.resolve(identifier.getText(), octave);

        <span class="hljs-keyword">if</span> (chord == <span class="hljs-keyword">null</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndefinedReferenceException(identifier, <span class="hljs-string">"Identifier ("</span>+identifier.getText()+<span class="hljs-string">") is undefined."</span>);

        <span class="hljs-keyword">return</span> chord;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">appendToMelody</span><span class="hljs-params">(Melody root, BlockOptions context, MidiNoteMessageSource notes, Token identifier, Articulation articulation)</span> </span>{
        <span class="hljs-keyword">if</span> (notes == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.symbolTable.identifierTypeIs(identifier.getText(), Melody.class)) {
                Melody mel = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValue(identifier.getText(), Melody.class).inOctave(context.getOctave());
                root.add(mel);
            } <span class="hljs-keyword">else</span> {
                Chord chord = lookupChord(identifier, context.getOctave());
                root.add(<span class="hljs-keyword">new</span> ArticulatedSound(chord, articulation));
            }
        } <span class="hljs-keyword">else</span> {
            root.add(<span class="hljs-keyword">new</span> ArticulatedSound(notes, articulation));
        }
    }
}

octaveShift
    : ( PLUS | MINUS ) NUMBER;

articulation
returns [Articulation art]
    : DOT           {$art = Articulation.STACCATO;      }
    | EXCLAMATION   {$art = Articulation.STACCATISSIMO; }
    | HAT           {$art = Articulation.MARCATO;       }
    | BACK_TICK     {$art = Articulation.ACCENT;        }
    | USCORE        {$art = Articulation.TENUTO;        }
    | TILDA         {$art = Articulation.GLISCANDO;     }
    ;

noteChar[BlockOptions options]
returns [Pitch pitch]
    : A     {$pitch = Pitch.A.inOctave($options.getOctave());}
    | B     {$pitch = Pitch.B.inOctave($options.getOctave());}
    | C     {$pitch = Pitch.C.inOctave($options.getOctave());}
    | D     {$pitch = Pitch.D.inOctave($options.getOctave());}
    | E     {$pitch = Pitch.E.inOctave($options.getOctave());}
    | F     {$pitch = Pitch.F.inOctave($options.getOctave());}
    | G     {$pitch = Pitch.G.inOctave($options.getOctave());}
    ;

noteDef[BlockOptions options]
returns [Pitch pitch]
    :   ( noteChar[$options]    {$pitch = $noteChar.pitch;}
            (   SHARP           {$pitch = $pitch.sharp();}
            |   FLAT            {$pitch = $pitch.flat();}
            )?
            ( octaveShift {$pitch = $pitch.shiftOctave(Integer.parseInt($octaveShift.text));} )?
        )
    ;

chordParam[BlockOptions options]
returns [List&lt;Pitch&gt; pitches]
    : noteDef[$options] {$pitches = Collections.singletonList($noteDef.pitch);}
    | IDENTIFIER {!$options.isPercussion()}? ( COLON NUMBER )?
        {
            <span class="hljs-keyword">if</span> ($options.isPercussion()) {
                GeneralMidiPercussion drumSound = GeneralMidiPercussion.lookup($IDENTIFIER.getText());
                <span class="hljs-keyword">if</span> (drumSound != <span class="hljs-keyword">null</span>)
                    $pitches = Collections.singletonList(drumSound.getAsPitch());
            }
            <span class="hljs-keyword">if</span> ($pitches != <span class="hljs-keyword">null</span>) {
                Chord chord = lookupChord($IDENTIFIER, $options.getOctave());
                <span class="hljs-keyword">if</span> ($NUMBER == <span class="hljs-keyword">null</span>) {
                    $pitches = chord.getPitches();
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">int</span> index = $NUMBER.<span class="hljs-keyword">int</span> - <span class="hljs-number">1</span>; <span class="hljs-comment">//Indexing will start at 1</span>
                    <span class="hljs-keyword">if</span> (index &gt; chord.size())
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($IDENTIFIER, <span class="hljs-string">"Index "</span>+index+<span class="hljs-string">" is larger than the chord size of "</span>+chord.size());
                    $pitches = Collections.singletonList(chord.getPitch(index));
                }
            }
        }
    ;

chord[BlockOptions options]
returns [ArticulatedSound sound]
locals [List&lt;Pitch&gt; pitches = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;()]
    :   PAREN_OPEN
        chordParam[$options] {$pitches.addAll($chordParam.pitches);}
        ( COMMA chordParam[$options] {$pitches.addAll($chordParam.pitches);} )*
        PAREN_CLOSE {$sound = <span class="hljs-keyword">new</span> ArticulatedSound(<span class="hljs-keyword">new</span> Chord($pitches), Articulation.NONE);}
        ( articulation {$sound.setArticulation($articulation.art);} )? ;

melodyParam[BlockOptions options]
returns [MidiNoteMessageSource notes = <span class="hljs-keyword">null</span>, Token identifier = <span class="hljs-keyword">null</span>, Articulation art = Articulation.NONE]
    :    noteDef[$options] {$notes = $noteDef.pitch;}
            ( articulation {$art = $articulation.art;} )?

    |    IDENTIFIER
            ({!$options.isPercussion()}? COLON NUMBER
                {
                    Chord chord = lookupChord($IDENTIFIER, $options.getOctave());
                    <span class="hljs-keyword">int</span> index = $NUMBER.<span class="hljs-keyword">int</span> - <span class="hljs-number">1</span>; <span class="hljs-comment">//Indexing will start at 1</span>
                    <span class="hljs-keyword">if</span> (index &gt; chord.size())
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($IDENTIFIER, <span class="hljs-string">"Index "</span>+index+<span class="hljs-string">" is larger than the chord size of "</span>+chord.size());
                    $notes = chord.getPitch(index);
                }
            )?
            {   <span class="hljs-keyword">if</span> ($notes == <span class="hljs-keyword">null</span>) {
                    <span class="hljs-keyword">if</span> ($options.isPercussion()) {
                        GeneralMidiPercussion drumSound = GeneralMidiPercussion.lookup($IDENTIFIER.getText());
                        <span class="hljs-keyword">if</span> (drumSound == <span class="hljs-keyword">null</span>)
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndefinedReferenceException($IDENTIFIER, <span class="hljs-string">"Unknown drum sound "</span>+$IDENTIFIER.getText());
                        $notes = drumSound.getAsPitch();
                    } <span class="hljs-keyword">else</span> {
                        $identifier = $IDENTIFIER;
                    }
                }
            }
            ( articulation {$art = $articulation.art;} )?

    | chord[$options]   {
                            $notes = $chord.sound.getSound();
                            $art = $chord.sound.getArticulation();
                        }
    | STAR {$notes = Pitch.REST;}
    ;

melody[BlockOptions options]
returns [Melody mel = <span class="hljs-keyword">new</span> Melody(<span class="hljs-keyword">new</span> LinkedList&lt;ArticulatedSound&gt;())]
    :   BRACKET_OPEN
        melodyParam[$options] {appendToMelody($mel, $options, $melodyParam.notes, $melodyParam.identifier, $melodyParam.art);}
        ( COMMA melodyParam[$options] {appendToMelody($mel, $options, $melodyParam.notes, $melodyParam.identifier, $melodyParam.art);} )*
        BRACKET_CLOSE
    ;

rhythmChar
returns [Beat beat]
    : W {$beat = Beat.WHOLE;        }
    | H {$beat = Beat.HALF;         }
    | Q {$beat = Beat.QUARTER;      }
    | E {$beat = Beat.EIGHTH;       }
    | S {$beat = Beat.SIXTEENTH;    }
    | T {$beat = Beat.THIRTYSECOND; }
    ;

rhythmDef
returns [Beat beat]
    : rhythmChar ( DOT )* {$beat = $DOT == <span class="hljs-keyword">null</span> ? $rhythmChar.beat : $rhythmChar.beat.dot($DOT.text.length());};

slurredRhythm[Rhythm rhy]
    : PAREN_OPEN rhythmParam[$rhy, <span class="hljs-keyword">true</span>] ( COMMA rhythmParam[$rhy, <span class="hljs-keyword">true</span>] )* PAREN_CLOSE ;

rhythmParam[Rhythm rhy, <span class="hljs-keyword">boolean</span> slur]
    : rhythmDef     { $rhy.append($rhythmDef.beat, $slur);}
    | IDENTIFIER    {
                        Rhythm value = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValueOrThrow($IDENTIFIER, Rhythm.class);
                        $rhy.append(value, $slur);
                    }
    | slurredRhythm[$rhy]
    ;

rhythm
returns [Rhythm rhy = <span class="hljs-keyword">new</span> Rhythm()]
    : P_BRACKET_OPEN rhythmParam[$rhy, <span class="hljs-keyword">false</span>] ( COMMA rhythmParam[$rhy, <span class="hljs-keyword">false</span>] )* P_BRACKET_CLOSE ;

varDeclaration
    : <span class="hljs-function">IDENTIFIER <span class="hljs-title">ASSIGNMENT</span> <span class="hljs-params">( chord [<span class="hljs-keyword">this</span>.globalOptions]    {<span class="hljs-keyword">this</span>.symbolTable.addDeclaration($IDENTIFIER.text, $chord.sound.getSound()</span>)</span>;}
                            | melody[<span class="hljs-keyword">this</span>.globalOptions]    {<span class="hljs-keyword">this</span>.symbolTable.addDeclaration($IDENTIFIER.text, $melody.mel);}
                            | rhythm                        {<span class="hljs-keyword">this</span>.symbolTable.addDeclaration($IDENTIFIER.text, $rhythm.rhy);}
                            | phrase[<span class="hljs-keyword">this</span>.globalOptions]    {<span class="hljs-keyword">this</span>.symbolTable.addDeclaration($IDENTIFIER.text, $phrase.phr);}
                            )
    ;

dynamicDeclaration
returns [Dynamic dynamic]
    : PPPP  {$dynamic = Dynamic.pppp;}
    | PPP   {$dynamic = Dynamic.ppp; }
    | PP    {$dynamic = Dynamic.pp;  }
    | P     {$dynamic = Dynamic.p;   }
    | MP    {$dynamic = Dynamic.mp;  }
    | MF    {$dynamic = Dynamic.mf;  }
    | F     {$dynamic = Dynamic.f;   }
    | FF    {$dynamic = Dynamic.ff;  }
    | FFF   {$dynamic = Dynamic.fff; }
    | FFFF  {$dynamic = Dynamic.ffff;}
    ;

blockOptions[BlockOptions options]
    : BRACKET_OPEN ( ( propertyOption[$options] | flagOption[$options] ) ( COMMA ( propertyOption[$options] | flagOption[$options] ) )* )? BRACKET_CLOSE;

propertyOption[BlockOptions options]
    : key=<span class="hljs-function">IDENTIFIER <span class="hljs-title">ASSIGNMENT</span> <span class="hljs-params">( valueID=IDENTIFIER | valueNum=NUMBER )</span>
        </span>{   <span class="hljs-keyword">switch</span>($key.text.toLowerCase()) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"instrument"</span>:
                    <span class="hljs-keyword">if</span> ($valueID != <span class="hljs-keyword">null</span>) {
                        $options.setInstrument($valueID);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">int</span> inst = $valueNum.<span class="hljs-keyword">int</span>;
                        <span class="hljs-keyword">if</span> (inst &gt; <span class="hljs-number">127</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueNum, <span class="hljs-string">"Instrument code must be less than 128."</span>);
                        $options.setInstrument(inst);
                    }
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"soundbank"</span>:
                    <span class="hljs-keyword">if</span> ($valueNum == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueID, <span class="hljs-string">"Expected a soundbank id but found "</span>+$valueID.text);
                    $options.setSoundbank($valueNum.<span class="hljs-keyword">int</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"octave"</span>:
                    <span class="hljs-keyword">if</span> ($valueNum == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueID, <span class="hljs-string">"Expected octave number but found "</span>+$valueID.text);
                    <span class="hljs-keyword">int</span> octave = $valueNum.<span class="hljs-keyword">int</span>;
                    <span class="hljs-keyword">if</span> (octave &gt; <span class="hljs-number">10</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueNum, <span class="hljs-string">"Octave is too high. 10 is highest byt found "</span>+octave);
                    $options.setOctave(octave);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"loop"</span>:
                    <span class="hljs-keyword">if</span> ($valueNum == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueID, <span class="hljs-string">"Expected a loop count but found "</span>+$valueID.text);
                    $options.setLoopCount($valueNum.<span class="hljs-keyword">int</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"onchannel"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"samechannelas"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"sharechannel"</span>:
                    <span class="hljs-keyword">if</span> ($valueID == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueNum, <span class="hljs-string">"Expected the name of the block that this channel should share a channel with"</span>
                            + <span class="hljs-string">" but found "</span> + $valueNum.text);
                    $options.setShareChannel($valueID.text);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"channel"</span>:
                    <span class="hljs-keyword">if</span> ($valueNum == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($valueID, <span class="hljs-string">"Expected the number of the MIDI channel to requests but"</span>
                            + <span class="hljs-string">" found "</span> + $valueID.text);
                    $options.setChannel($valueNum.<span class="hljs-keyword">int</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($key, <span class="hljs-string">"Unknow block option "</span> + $key.text + <span class="hljs-string">"."</span>);
            }
        }
    ;

flagOption[BlockOptions options]
    :   ( off=MINUS )? flag=IDENTIFIER
        {
            <span class="hljs-keyword">switch</span> ($flag.text.toLowerCase()) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"percussion"</span>:
                <span class="hljs-keyword">case</span> <span class="hljs-string">"drums"</span>:
                    $options.setPercussion($off == <span class="hljs-keyword">null</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($flag, <span class="hljs-string">"Unknow block option "</span> + $flag.text + <span class="hljs-string">"."</span>);
            }
        }
    ;

phrase[BlockOptions options]
returns [Phrase phr]
locals [Melody mel]
    :   (   ( melody[$options]  {$mel = $melody.mel;}
            | chord[$options]   {$mel = <span class="hljs-keyword">new</span> Melody(Arrays.asList($chord.sound));}
            | IDENTIFIER articulation?
                            {
                                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.symbolTable.identifierTypeIs($IDENTIFIER.getText(), Melody.class)) {
                                    $mel = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValue($IDENTIFIER.getText(), Melody.class).inOctave($options.getOctave());
                                    <span class="hljs-keyword">if</span> ($articulation.ctx != <span class="hljs-keyword">null</span>)
                                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IncorrectTypeException($IDENTIFIER, <span class="hljs-string">"Cannot articulate a melody."</span>);
                                } <span class="hljs-keyword">else</span> {
                                    Chord chord = lookupChord($IDENTIFIER, $options.getOctave());
                                    List&lt;ArticulatedSound&gt; notes = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
                                    notes.add(<span class="hljs-keyword">new</span> ArticulatedSound(chord, $articulation.ctx == <span class="hljs-keyword">null</span> ? Articulation.NONE : $articulation.art));
                                    $mel = <span class="hljs-keyword">new</span> Melody(notes);
                                }
                            }
            ) STAR
            ( rhythm {$phr = $rhythm.rhy.createPhrase($mel);}
            | IDENTIFIER {$phr = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValueOrThrow($IDENTIFIER, Rhythm.class).createPhrase($mel);}
            )
        )
        |
        ( IDENTIFIER {$phr = <span class="hljs-keyword">this</span>.symbolTable.getDeclarationValueOrThrow($IDENTIFIER, Phrase.class).inOctave($options.getOctave());} )
    ;

block
locals [Block b, BlockOptions options]
    :   IDENTIFIER {$b = <span class="hljs-keyword">this</span>.trackManager.getBlock($IDENTIFIER.text); $options  = <span class="hljs-keyword">new</span> BlockOptions($b == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">this</span>.globalOptions : $b.getOptions());} blockOptions[$options]? BRACE_OPEN
            {
                <span class="hljs-keyword">if</span> ($b == <span class="hljs-keyword">null</span>)
                    $b = <span class="hljs-keyword">this</span>.trackManager.createBlock($IDENTIFIER, <span class="hljs-keyword">this</span>.timingEnv, <span class="hljs-keyword">this</span>.midiSequence.createTrack(), $options);
                <span class="hljs-keyword">try</span> {
                    $b.enterBlock($IDENTIFIER, $options);
                } <span class="hljs-keyword">catch</span> (InvalidMidiDataException e) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($blockOptions.start, e.getMessage());
                }
            }
        (
            ( dynamicDeclaration    {
                                        <span class="hljs-keyword">try</span> {
                                            $b.setDynamic($dynamicDeclaration.dynamic);
                                        } <span class="hljs-keyword">catch</span> (InvalidMidiDataException e) {
                                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($dynamicDeclaration.start, e.getMessage());
                                        }
                                    }
                ( DYNAMIC_CRES      {$b.crescendo($DYNAMIC_CRES);}
                | DYNAMIC_DECRES    {$b.decrescendo($DYNAMIC_DECRES);}
                )?
            )
        | phrase[$options]    {
                                            <span class="hljs-keyword">try</span> {
                                                $b.addPhrase($phrase.phr);
                                            } <span class="hljs-keyword">catch</span> (InvalidMidiDataException e) {
                                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException($dynamicDeclaration.start, e.getMessage());
                                            }
                                        }
        )* BRACE_CLOSE {$b.leaveBlock();}
    ;

song
    :   ( varDeclaration
        | block
        )*
    ;</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
