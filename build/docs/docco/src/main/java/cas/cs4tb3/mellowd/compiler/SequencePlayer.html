<!DOCTYPE html>

<html>
<head>
  <title>Sequence Player</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="..\..\..\..\..\..\..\docco.css" />
</head>
<body>
<a href="https://github.com/SpencerPark/MellowD"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <div class="toctop" onclick="">
            <a class="source" href="..\..\..\..\..\..\..\index.html">Home</a>
            <h3>Table of Contents</h3>
              
                    
                    <div class="toc" onclick="">
                        <h3>src\main\antlr</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\antlr\MellowDLexer.html">
                                    MellowDLexer.g4
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\antlr\MellowDParser.html">
                                    MellowDParser.g4
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\ArticulatedSound.html">
                                    ArticulatedSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Articulation.html">
                                    Articulation.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Beat.html">
                                    Beat.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Dynamic.html">
                                    Dynamic.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Pitch.html">
                                    Pitch.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\PlayableSound.html">
                                    PlayableSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\TimingEnvironment.html">
                                    TimingEnvironment.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\compiler</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="Compiler.html">
                                    Compiler.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="SequencePlayer.html">
                                    SequencePlayer.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\midi</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\GeneralMidiConstants.html">
                                    GeneralMidiConstants.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\GeneralMidiInstrument.html">
                                    GeneralMidiInstrument.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\GeneralMidiPercussion.html">
                                    GeneralMidiPercussion.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\MidiNoteMessageSource.html">
                                    MidiNoteMessageSource.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\parser</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\Block.html">
                                    Block.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\BlockOptions.html">
                                    BlockOptions.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\IncorrectTypeException.html">
                                    IncorrectTypeException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\ParseException.html">
                                    ParseException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\SymbolTable.html">
                                    SymbolTable.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\TrackManager.html">
                                    TrackManager.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\UndefinedReferenceException.html">
                                    UndefinedReferenceException.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\primitives</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Chord.html">
                                    Chord.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Melody.html">
                                    Melody.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Phrase.html">
                                    Phrase.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Rhythm.html">
                                    Rhythm.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\ChordResolutionTest.html">
                                    ChordResolutionTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\CompilerTest.html">
                                    CompilerTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\ErrorResponseTest.html">
                                    ErrorResponseTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\ParserTest.html">
                                    ParserTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\TestErrorListener.html">
                                    TestErrorListener.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\compilertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\articulation.html">
                                    articulation.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\percussion.html">
                                    percussion.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\strangeChords.html">
                                    strangeChords.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\strangeMelodies.html">
                                    strangeMelodies.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\strangeRhythms.html">
                                    strangeRhythms.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\varDeclarations.html">
                                    varDeclarations.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\errortest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\errortest\largeInput.html">
                                    largeInput.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\errortest\largeInputShared.html">
                                    largeInputShared.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\parsertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\parsertest\chordNames.html">
                                    chordNames.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\parsertest\simpleBlock.html">
                                    simpleBlock.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\parsertest\varDeclaration.html">
                                    varDeclaration.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\testdata</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\testdata\CompilerTestData.html">
                                    CompilerTestData.json
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\testdata\ParserTestData.html">
                                    ParserTestData.json
                                </a>
                            </li>
                        
                        </div>
                    
          </div>
        
            
            <!-- Moved TOC above header -->
            
          
          <h1 id="sequence-player">Sequence Player</h1>

          
            <div class='highlight'><pre>
<span class="hljs-keyword">package</span> cas.cs4tb3.mellowd.compiler;

<span class="hljs-keyword">import</span> javax.sound.midi.*;
<span class="hljs-keyword">import</span> java.util.concurrent.ExecutionException;
<span class="hljs-keyword">import</span> java.util.concurrent.Future;
<span class="hljs-keyword">import</span> java.util.concurrent.FutureTask;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</pre></div>
          
        
      </div>

      
        
        <p>This class is a simple playback manager that provides some concurrency features
wrapped around the java midi sequencer. It provides <code>play()</code> and <code>stop()</code> methods
for starting and stopping the sequence passed in at construction time.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SequencePlayer</span> </span>{</pre></div>
        
      
        
        <p>The <code>PLAYER_NUM</code> will be used to better track the various threads created for playback</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AtomicInteger PLAYER_NUM = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">0</span>);</pre></div>
        
      
        
        <p>This is the midi message type for the end of track meta message</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> END_OF_TRACK_MESSAGE = <span class="hljs-number">0x2F</span>;</pre></div>
        
      
        
        <p>Store the player and playback data</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sequencer sequencer;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sequence sequence;</pre></div>
        
      
        
        <p>Track the state of this player such that <code>true</code> &harr; music playing.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isPlaying;</pre></div>
        
      
        
        <p>This constructor simply takes the desired sequence player and sequence to play</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SequencePlayer</span><span class="hljs-params">(Sequencer sequencer, Sequence sequence)</span> </span>{
        <span class="hljs-keyword">this</span>.sequencer = sequencer;
        <span class="hljs-keyword">this</span>.sequence = sequence;</pre></div>
        
      
        
        <p>To correctly update the <code>isPlaying</code> state variable we will register a listener
that sets the flag to false when it hears the sequencer end a track.</p>

        
          <div class='highlight'><pre>        sequencer.addMetaEventListener(<span class="hljs-keyword">new</span> MetaEventListener() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">meta</span><span class="hljs-params">(MetaMessage meta)</span> </span>{
                <span class="hljs-keyword">if</span> (meta.getType() == END_OF_TRACK_MESSAGE) {
                    isPlaying = <span class="hljs-keyword">false</span>;
                }
            }
        });
    }</pre></div>
        
      
        
        <p>Here is the major part of this class. The <code>play()</code> method will play the sequence asynchronously
as the Sequencer already does but will also return a <code>Future</code> that will complete when the song
has finished playing or the playback has been aborted.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">public</span> Future&lt;SequencePlayer&gt; <span class="hljs-title">play</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> MidiUnavailableException, InvalidMidiDataException </span>{</pre></div>
        
      
        
        <p>Firstly check if this player is already in action, we can only allow one playback at a time</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (isPlaying) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"Player is already playing."</span>);</pre></div>
        
      
        
        <p>Now we can set up the sequencer by opening it up and putting in our midi sequence</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!sequencer.isOpen()) sequencer.open();
        sequencer.setSequence(sequence);</pre></div>
        
      
        
        <p>Next we start playing the sequence and set the flag to reflect this.</p>

        
          <div class='highlight'><pre>        isPlaying = <span class="hljs-keyword">true</span>;
        sequencer.start();</pre></div>
        
      
        
        <p>Here we are creating a virtual workload that is going to poll the <code>isPlaying</code> flag
every 50ms to check if the playback is complete. If it is the playback is finished and
the task completes. This allows for syncing with this task or polling its <code>isDone()</code>
method to integrate the playback into the application.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">final</span> FutureTask&lt;SequencePlayer&gt; player = <span class="hljs-keyword">new</span> FutureTask&lt;SequencePlayer&gt;(<span class="hljs-keyword">new</span> Runnable() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">while</span> (isPlaying) {
                    <span class="hljs-keyword">try</span> {
                        Thread.sleep(<span class="hljs-number">50L</span>);
                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                        <span class="hljs-keyword">break</span>;
                    }
                }
            }
        }, <span class="hljs-keyword">this</span>) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">done</span><span class="hljs-params">()</span> </span>{
                stop();
            }
        };</pre></div>
        
      
        
        <p>Lastly we can startup a new thread and run the worker on it.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-string">"SequencePlayer-"</span>+PLAYER_NUM.getAndIncrement()) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
                player.run();
            }
        }.start();
        <span class="hljs-keyword">return</span> player;
    }</pre></div>
        
      
        
        <p>This convenience method just executes it’s asynchronous counterpart and block until
it’s completion.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">playSync</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InvalidMidiDataException, MidiUnavailableException </span>{
        <span class="hljs-keyword">try</span> {
            play().get();
        } <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException ignore) { }
    }</pre></div>
        
      
        
        <p>Stop will halt the playback if a playback is occurring, otherwise it will do nothing.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isPlaying) {
            <span class="hljs-keyword">this</span>.isPlaying = <span class="hljs-keyword">false</span>;
            <span class="hljs-keyword">this</span>.sequencer.stop();
        }
    }
}</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
