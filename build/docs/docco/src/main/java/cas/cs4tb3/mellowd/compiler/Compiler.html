<!DOCTYPE html>

<html>
<head>
  <title>Compiler</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="..\..\..\..\..\..\..\docco.css" />
</head>
<body>
<a href="https://github.com/SpencerPark/MellowD"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <div class="toctop" onclick="">
            <a class="source" href="..\..\..\..\..\..\..\index.html">Home</a>
            <h3>Table of Contents</h3>
              
                    
                    <div class="toc" onclick="">
                        <h3>src\main\antlr</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\antlr\MellowDLexer.html">
                                    MellowDLexer.g4
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\antlr\MellowDParser.html">
                                    MellowDParser.g4
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\ArticulatedSound.html">
                                    ArticulatedSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Articulation.html">
                                    Articulation.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Beat.html">
                                    Beat.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Dynamic.html">
                                    Dynamic.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Pitch.html">
                                    Pitch.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\PlayableSound.html">
                                    PlayableSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\TimingEnvironment.html">
                                    TimingEnvironment.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\compiler</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="Compiler.html">
                                    Compiler.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="MIDIIODelegate.html">
                                    MIDIIODelegate.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="SequenceIODelegate.html">
                                    SequenceIODelegate.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="SequencePlayer.html">
                                    SequencePlayer.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="TimeStampedMIDIMessage.html">
                                    TimeStampedMIDIMessage.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="VirtualMIDIPlayer.html">
                                    VirtualMIDIPlayer.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="WavIODelegate.html">
                                    WavIODelegate.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\midi</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\GeneralMidiConstants.html">
                                    GeneralMidiConstants.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\GeneralMidiInstrument.html">
                                    GeneralMidiInstrument.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\GeneralMidiPercussion.html">
                                    GeneralMidiPercussion.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\MidiNoteMessageSource.html">
                                    MidiNoteMessageSource.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\parser</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\Block.html">
                                    Block.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\BlockOptions.html">
                                    BlockOptions.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\IncorrectTypeException.html">
                                    IncorrectTypeException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\ParseException.html">
                                    ParseException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\SymbolTable.html">
                                    SymbolTable.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\TrackManager.html">
                                    TrackManager.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\parser\UndefinedReferenceException.html">
                                    UndefinedReferenceException.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\primitives</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Chord.html">
                                    Chord.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Melody.html">
                                    Melody.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Phrase.html">
                                    Phrase.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Rhythm.html">
                                    Rhythm.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\ChordResolutionTest.html">
                                    ChordResolutionTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\CompilerTest.html">
                                    CompilerTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\ErrorResponseTest.html">
                                    ErrorResponseTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\ParserTest.html">
                                    ParserTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\TestErrorListener.html">
                                    TestErrorListener.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\compilertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\articulation.html">
                                    articulation.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\percussion.html">
                                    percussion.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\strangeChords.html">
                                    strangeChords.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\strangeMelodies.html">
                                    strangeMelodies.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\strangeRhythms.html">
                                    strangeRhythms.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\varDeclarations.html">
                                    varDeclarations.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\errortest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\errortest\largeInput.html">
                                    largeInput.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\errortest\largeInputShared.html">
                                    largeInputShared.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\parsertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\parsertest\chordNames.html">
                                    chordNames.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\parsertest\simpleBlock.html">
                                    simpleBlock.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\parsertest\varDeclaration.html">
                                    varDeclaration.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\testdata</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\testdata\CompilerTestData.html">
                                    CompilerTestData.json
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\testdata\ParserTestData.html">
                                    ParserTestData.json
                                </a>
                            </li>
                        
                        </div>
                    
          </div>
        
            
            <!-- Moved TOC above header -->
            
          
          <h1 id="compiler">Compiler</h1>

          
            <div class='highlight'><pre>
<span class="hljs-keyword">package</span> cas.cs4tb3.mellowd.compiler;

<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.TimingEnvironment;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.midi.GeneralMidiConstants;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.parser.MellowDLexer;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.parser.MellowDParser;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.parser.ParseException;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.parser.TrackManager;
<span class="hljs-keyword">import</span> net.sourceforge.argparse4j.ArgumentParsers;
<span class="hljs-keyword">import</span> net.sourceforge.argparse4j.impl.Arguments;
<span class="hljs-keyword">import</span> net.sourceforge.argparse4j.inf.*;
<span class="hljs-keyword">import</span> org.antlr.v4.runtime.*;
<span class="hljs-keyword">import</span> org.antlr.v4.runtime.misc.ParseCancellationException;

<span class="hljs-keyword">import</span> javax.sound.midi.*;
<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.nio.file.Paths;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;</pre></div>
          
        
      </div>

      
        
        <p>The <code>Compiler</code> class is the main entry point for the program.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Compiler</span> </span>{</pre></div>
        
      
        
        <p>Empty sequences will have this event appended to create a playable empty sequence.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImmutableEndOfTrack</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MetaMessage</span> </span>{
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span> EOT_EVENT_CODE = <span class="hljs-number">0x2F</span>;

        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">ImmutableEndOfTrack</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">super</span>(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">3</span>]);
            data[<span class="hljs-number">0</span>] = (<span class="hljs-keyword">byte</span>) META;
            data[<span class="hljs-number">1</span>] = EOT_EVENT_CODE;
            data[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMessage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> type, <span class="hljs-keyword">byte</span>[] data, <span class="hljs-keyword">int</span> length)</span> <span class="hljs-keyword">throws</span> InvalidMidiDataException </span>{
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidMidiDataException(<span class="hljs-string">"cannot modify end of track message"</span>);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> MidiMessage EOT_MESSAGE = <span class="hljs-keyword">new</span> ImmutableEndOfTrack();
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String FILE_EXTENSION = <span class="hljs-string">".mlod"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</pre></div>
        
      
        
        <p>The ArgumentParser is from the <a href="https://argparse4j.github.io/">argparse4j</a>. It is
a library for parsing command line arguments.</p>

        
      
        
        <p>Create a new parser for the mellowd command. The defaultHelp create a <code>-h</code> option
that displays a help menu for the command.</p>

        
          <div class='highlight'><pre>        ArgumentParser argParser = ArgumentParsers.newArgumentParser(<span class="hljs-string">"mellowd"</span>)
                .defaultHelp(<span class="hljs-keyword">true</span>)
                .version(<span class="hljs-string">"1.0.0"</span>);</pre></div>
        
      
        
        <p>The <code>-p</code> option is a flag so the action will be storeTrue so that the value
of this argument will be false if not present and true if it is present. If
<code>-p</code> is set the program will immediately playback the compiled song.</p>

        
          <div class='highlight'><pre>        argParser.addArgument(<span class="hljs-string">"-p"</span>, <span class="hljs-string">"--play"</span>)
                .action(Arguments.storeTrue())
                .help(<span class="hljs-string">"Playback the specified file instead of exporting it."</span>);</pre></div>
        
      
        
        <p>The <code>-o</code> option specifies the output directory. By default this is just the current
directory. The type of the argument is a file so the parser tries to parse a path.</p>

        
          <div class='highlight'><pre>        argParser.addArgument(<span class="hljs-string">"-o"</span>, <span class="hljs-string">"--outdir"</span>)
                .nargs(<span class="hljs-string">"?"</span>)
                .setDefault(Paths.get(<span class="hljs-string">""</span>).toAbsolutePath().toFile())
                .type(Arguments.fileType())
                .help(<span class="hljs-string">"Set the output directory for the compilation."</span>);</pre></div>
        
      
        
        <p>The <code>-ts</code> option specifies the time signature. This is <sup>4</sup>&frasl;<sub>4</sub>
by default. To specify a new time signature both the numerator and denominator must
be given. Otherwise neither need to be given.</p>

        
          <div class='highlight'><pre>        argParser.addArgument(<span class="hljs-string">"-ts"</span>, <span class="hljs-string">"--timesig"</span>)
                .nargs(<span class="hljs-number">2</span>)
                .type(<span class="hljs-keyword">byte</span>.class)
                .setDefault(<span class="hljs-number">4</span>, <span class="hljs-number">4</span>)
                .required(<span class="hljs-keyword">false</span>)
                .metavar(<span class="hljs-string">"numerator"</span>, <span class="hljs-string">"denominator"</span>)
                .help(<span class="hljs-string">"Specify the numerator and denominator of the time signature (Ex: 4 4 for 4/4)."</span>);</pre></div>
        
      
        
        <p>The <code>-t</code> options specifies the tempo. A standard tempo is 120 bpm so that is the default. To
change the tempo the <code>-t</code> argument must be followed by a number that represents the tempo in
beats per minute.</p>

        
          <div class='highlight'><pre>        argParser.addArgument(<span class="hljs-string">"-t"</span>, <span class="hljs-string">"--tempo"</span>)
                .nargs(<span class="hljs-string">"?"</span>)
                .metavar(<span class="hljs-string">"tempo"</span>)
                .type(<span class="hljs-keyword">int</span>.class)
                .setDefault(<span class="hljs-number">120</span>)
                .help(<span class="hljs-string">"Specify the tempo of the compiled song in BPM."</span>);</pre></div>
        
      
        
        <p>There are various flags that can specify what output formats to write the file as.</p>

        
          <div class='highlight'><pre>        MutuallyExclusiveGroup outputFormat = argParser.addMutuallyExclusiveGroup(<span class="hljs-string">"output format"</span>)
                .description(<span class="hljs-string">"Set the output format of the compiler. This defaults to MIDI (.mid)"</span>);
        outputFormat.addArgument(<span class="hljs-string">"--mid"</span>, <span class="hljs-string">"--midi"</span>)
                .dest(<span class="hljs-string">"IODelegate"</span>)
                .action(Arguments.storeConst())
                .setConst(MIDIIODelegate.getInstance())
                .setDefault(MIDIIODelegate.getInstance())
                .help(<span class="hljs-string">"Set the output type of the compiler to a MIDI file (.mid). Default: MIDI (.mid)"</span>);
        outputFormat.addArgument(<span class="hljs-string">"--wav"</span>, <span class="hljs-string">"--wave"</span>)
                .dest(<span class="hljs-string">"IODelegate"</span>)
                .action(Arguments.storeConst())
                .setConst(WavIODelegate.getInstance())
                .help(<span class="hljs-string">"Set the output type of the compiler to a WAVE file (.wav). Default: MIDI (.mid)"</span>);</pre></div>
        
      
        
        <p>The last argument is a required argument. The file to compile. The given file must exist
and be readable.</p>

        
          <div class='highlight'><pre>        argParser.addArgument(<span class="hljs-string">"file"</span>)
                .type(Arguments.fileType()
                        .verifyExists()
                        .verifyCanRead())
                .help(<span class="hljs-string">"Specify the file to compile."</span>);</pre></div>
        
      
        
        <p>Now that the parser is constructed we can parse the input arguments.</p>

        
          <div class='highlight'><pre>        Namespace arguments = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {
            arguments = argParser.parseArgs(args);
        } <span class="hljs-keyword">catch</span> (ArgumentParserException e) {</pre></div>
        
      
        
        <p>If the parse fails forward the error to the parser
for a nicely formatted error message and then exit because
we don’t have the correct arguments to run the compiler.</p>

        
          <div class='highlight'><pre>            argParser.handleError(e);
            System.exit(<span class="hljs-number">1</span>);
        }</pre></div>
        
      
        
        <p>Now that we have valid arguments we need to pull the information
out of the parser.</p>

        
          <div class='highlight'><pre>        File outDir = handleOutDir(arguments.&lt;File&gt;get(<span class="hljs-string">"outdir"</span>));
        File toCompile = handleInFile(arguments.&lt;File&gt;get(<span class="hljs-string">"file"</span>));
        List&lt;Number&gt; tempo = arguments.getList(<span class="hljs-string">"timesig"</span>);</pre></div>
        
      
        
        <p>Now we can begin compiling</p>

        
          <div class='highlight'><pre>        Sequence compilationResult = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {</pre></div>
        
      
        
        <p>We want to track the compilation duration so mark the start time</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">long</span> startTime = System.nanoTime();</pre></div>
        
      
        
        <p>Compile the input file with the given timing arguments.</p>

        
          <div class='highlight'><pre>            compilationResult = compile(toCompile,
                    tempo.get(<span class="hljs-number">0</span>).byteValue(),
                    tempo.get(<span class="hljs-number">1</span>).byteValue(),
                    arguments.getInt(<span class="hljs-string">"tempo"</span>),
                    <span class="hljs-keyword">true</span>);</pre></div>
        
      
        
        <p>Calculate the compilation time and display it in seconds to 6 decimal places.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">long</span> compileTime = System.nanoTime() - startTime;
            System.out.printf(<span class="hljs-string">"Compilation took %.6f s\n"</span>,
                    compileTime / <span class="hljs-number">1E9</span>d);</pre></div>
        
      
        
        <p>Display the duration of the compiled song in seconds.</p>

        
          <div class='highlight'><pre>            System.out.printf(<span class="hljs-string">"Song length: %d s\n"</span>,
                    TimeUnit.MICROSECONDS.toSeconds(compilationResult.getMicrosecondLength()));</pre></div>
        
      
        
        <p>If an IOException occurs then we had a problem with the input file. We will
display the error and exit.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">catch</span> (IOException e) {
            System.out.printf(<span class="hljs-string">"Error reading input file (%s). Reason: %s\n"</span>,
                    toCompile.getAbsolutePath(), e.getLocalizedMessage());
            System.exit(<span class="hljs-number">1</span>);</pre></div>
        
      
        
        <p>If a ParseException occurs then there was a problem with the data in the input
file. The input is well formed but the semantics are wrong. Display the error and exit.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">catch</span> (ParseException e) {
            System.out.printf(<span class="hljs-string">"Exception encountered while compiling. %s\n"</span>, e.getLocalizedMessage());
            System.exit(<span class="hljs-number">1</span>);</pre></div>
        
      
        
        <p>A ParseCancellationException is different from a ParseException. It is thrown by ANTLR
when using the BailErrorStrategy. This is the result of a syntax error. Display the
error and exit.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">catch</span> (ParseCancellationException e) {
            RecognitionException ex = (RecognitionException) e.getCause();
            System.out.printf(<span class="hljs-string">"Parse exception in rule %s. Offending token: line %d@%d:'%s'. Expected: %s\n"</span>,
                    ex.getCtx().toString(ex.getRecognizer()),
                    ex.getOffendingToken().getLine(),
                    ex.getOffendingToken().getCharPositionInLine(),
                    ex.getOffendingToken().getText(),
                    ex.getExpectedTokens().toString(ex.getRecognizer().getVocabulary()));
            System.exit(<span class="hljs-number">1</span>);
        }

        <span class="hljs-keyword">try</span> {</pre></div>
        
      
        
        <p>If the play flag is set than we will play the <code>compilationResult</code> with the systems
midi sequencer.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> (arguments.getBoolean(<span class="hljs-string">"play"</span>)) {</pre></div>
        
      
        
        <p>Tell the user the song is playing.</p>

        
          <div class='highlight'><pre>                System.out.printf(<span class="hljs-string">"Playing %s\n"</span>, toCompile.getName().replace(FILE_EXTENSION, <span class="hljs-string">""</span>));</pre></div>
        
      
        
        <p>Create a music player from the sequencer and song.</p>

        
          <div class='highlight'><pre>                SequencePlayer player = <span class="hljs-keyword">new</span> SequencePlayer(MidiSystem.getSequencer(), compilationResult);</pre></div>
        
      
        
        <p>Make a blocking call to start playing the song</p>

        
          <div class='highlight'><pre>                player.playSync();</pre></div>
        
      
        
        <p>When playSync returns this means the song is done. Tell the user that the play is
completed and exit.</p>

        
          <div class='highlight'><pre>                System.out.println(<span class="hljs-string">"Play complete!"</span>);
                System.exit(<span class="hljs-number">0</span>);</pre></div>
        
      
        
        <p>If the play flag is not set the we will write the result to a file of the same name
located in the <code>outdir</code>.</p>

        
          <div class='highlight'><pre>            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">try</span> {</pre></div>
        
      
        
        <p>If the compilation result is empty then add the EOT event to
make the output file playable.</p>

        
          <div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (compilationResult.getTickLength() == <span class="hljs-number">0</span>) {
                        compilationResult.getTracks()[<span class="hljs-number">0</span>].add(<span class="hljs-keyword">new</span> MidiEvent(EOT_MESSAGE, <span class="hljs-number">1</span>));
                    }

                    SequenceIODelegate ioDelegate = arguments.get(<span class="hljs-string">"IODelegate"</span>);</pre></div>
        
      
        
        <p>The <code>outFile</code> is a file in the <code>outDir</code> with the same name as the file to compile
with the <code>.mid</code> file extension instead.</p>

        
          <div class='highlight'><pre>                    File outFile = <span class="hljs-keyword">new</span> File(outDir, toCompile.getName().replace(FILE_EXTENSION, ioDelegate.getExtension()));
                    <span class="hljs-keyword">if</span> (!outFile.exists()) outFile.createNewFile();

                    <span class="hljs-keyword">long</span> writeStartTime = System.nanoTime();
                    ioDelegate.save(compilationResult, outFile);
                    <span class="hljs-keyword">if</span> (ioDelegate != MIDIIODelegate.getInstance()) {</pre></div>
        
      
        
        <p>If we are not writing to a MIDI file then we should inform the user
that the expensive operation is converting to sound to the specified
type.</p>

        
          <div class='highlight'><pre>                        <span class="hljs-keyword">long</span> writeTime = System.nanoTime() - writeStartTime;
                        System.out.printf(<span class="hljs-string">"Conversion to %s took %.6f s\n"</span>,
                                ioDelegate.getExtension(), writeTime / <span class="hljs-number">1E9</span>d);
                    }</pre></div>
        
      
        
        <p>Display the compilation input and output locations for the user also
letting them know that the compilation was successful.</p>

        
          <div class='highlight'><pre>                    System.out.printf(<span class="hljs-string">"%s compiled to %s\n"</span>,
                            toCompile.getName().replace(FILE_EXTENSION, <span class="hljs-string">".mlod"</span>),
                            outFile.getPath());</pre></div>
        
      
        
        <p>If an IOException occurred let the user know the issue and exit.</p>

        
          <div class='highlight'><pre>                } <span class="hljs-keyword">catch</span> (IOException e) {
                    System.out.printf(<span class="hljs-string">"Error writing compilation result. Reason: %s.\n"</span>, e.getLocalizedMessage());
                    System.exit(<span class="hljs-number">1</span>);
                }
            }</pre></div>
        
      
        
        <p>If a MidiUnavailableException occurs let the user know the error and exit.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">catch</span> (MidiUnavailableException e) {
            System.out.printf(<span class="hljs-string">"Midi system not available. %s.\n"</span>, e.getLocalizedMessage());
            System.exit(<span class="hljs-number">1</span>);</pre></div>
        
      
        
        <p>If an InvalidMidiDataException occurs it is most likely our fault. This error
should be reported so ask the user to report it.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">catch</span> (InvalidMidiDataException e) {
            System.out.printf(<span class="hljs-string">"Midi compilation error. Something went wrong, please submit your source to"</span> +
                    <span class="hljs-string">" the bug tracker. Error: %s\n"</span>, e.getLocalizedMessage());
            System.exit(<span class="hljs-number">1</span>);
        }
    }</pre></div>
        
      
        
        <p><code>handleOutDir</code> tries its best to use the given <code>outDir</code> and if it can’t
it reports the problem to the user and closes the program.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> File <span class="hljs-title">handleOutDir</span><span class="hljs-params">(File outDir)</span> </span>{</pre></div>
        
      
        
        <p>If the directory doesn’t exits try and create it</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!outDir.exists()) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">boolean</span> created = outDir.mkdirs();</pre></div>
        
      
        
        <p>If <code>mkdirs</code> returns false the the directory doesn’t exist because we are
only at this point if it didn’t exists in the first place.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!created) {
                    System.out.printf(<span class="hljs-string">"Could not create outdir %s\n"</span>, outDir.getAbsolutePath());
                    System.exit(<span class="hljs-number">1</span>);
                }</pre></div>
        
      
        
        <p>If a SecurityException occurs let the user know that there is nothing we can do
to create the directory for them and close the program.</p>

        
          <div class='highlight'><pre>            } <span class="hljs-keyword">catch</span> (SecurityException e) {
                System.out.printf(<span class="hljs-string">"Could not create outdir (%s). Stopped by the security manager: %s"</span>,
                        outDir.getAbsolutePath(), e.getLocalizedMessage());
                System.exit(<span class="hljs-number">1</span>);
            }</pre></div>
        
      
        
        <p>If we make it down here than all went well and the directory was created so let
the user know we made a new directory on their machine.</p>

        
          <div class='highlight'><pre>            System.out.printf(<span class="hljs-string">"Created directory %s\n"</span>, outDir.getAbsolutePath());</pre></div>
        
      
        
        <p>If the path exists but is not a directory then we can’t put the compilation result
anywhere. Let the user know they gave us a path to an existing file and close the program.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!outDir.isDirectory()) {
            System.out.printf(<span class="hljs-string">"outdir (%s) is not a directory\n"</span>, outDir.getAbsolutePath());
            System.exit(<span class="hljs-number">1</span>);
        }</pre></div>
        
      
        
        <p>Return the file.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">return</span> outDir.getAbsoluteFile();
    }</pre></div>
        
      
        
        <p><code>handleInFile</code> does its best to use the input file given</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> File <span class="hljs-title">handleInFile</span><span class="hljs-params">(File inFile)</span> </span>{</pre></div>
        
      
        
        <p>If the file doesn’t exist then there is nothing to read. Tell the user the
problem and exit.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!inFile.exists()) {
            System.out.printf(<span class="hljs-string">"Cannot find input file %s.\n"</span>, inFile.getAbsolutePath());
            System.exit(<span class="hljs-number">1</span>);
        }</pre></div>
        
      
        
        <p>If the file doesn’t end with <code>.mlod</code> then it isn’t a Mellow D source and
the user most likely gave the wrong file. Let them know the file they gave
and tell them we can’t use it.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!inFile.getName().endsWith(FILE_EXTENSION)) {
            System.out.printf(<span class="hljs-string">"In file (%s) is not a Mellow D source file (.mlod).\n"</span>,
                    inFile.getAbsolutePath());
            System.exit(<span class="hljs-number">1</span>);
        }</pre></div>
        
      
        
        <p>Return the input file</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">return</span> inFile;
    }</pre></div>
        
      
        
        <p><code>compile</code> is the method that actually runs the compiler.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Sequence <span class="hljs-title">compile</span><span class="hljs-params">(File src, <span class="hljs-keyword">byte</span> numerator, <span class="hljs-keyword">byte</span> denominator, <span class="hljs-keyword">int</span> tempo, <span class="hljs-keyword">boolean</span> verbose)</span> <span class="hljs-keyword">throws</span> IOException </span>{</pre></div>
        
      
        
        <p>First we will display the inputs being used so they can double check everything
is as expected.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (verbose) {
            System.out.printf(<span class="hljs-string">"Time Signature: %d / %d\n"</span>, numerator, denominator);
            System.out.printf(<span class="hljs-string">"Tempo: %d bpm\n"</span>, tempo);
            System.out.printf(<span class="hljs-string">"Compiling file: %s\n"</span>, src.getPath());
        }</pre></div>
        
      
        
        <p>Now we can build a lexer with the <code>src</code> as the input.</p>

        
          <div class='highlight'><pre>        ANTLRFileStream inStream = <span class="hljs-keyword">new</span> ANTLRFileStream(src.getAbsolutePath());
        MellowDLexer lexer = <span class="hljs-keyword">new</span> MellowDLexer(inStream);</pre></div>
        
      
        
        <p>The parser takes the tokens from the lexer as well as the timing environment constructed
from the input arguments and a track manager.</p>

        
          <div class='highlight'><pre>        TokenStream tokens = <span class="hljs-keyword">new</span> CommonTokenStream(lexer);
        MellowDParser parser = <span class="hljs-keyword">new</span> MellowDParser(tokens, <span class="hljs-keyword">new</span> TimingEnvironment(numerator, denominator, tempo),
                <span class="hljs-keyword">new</span> TrackManager(GeneralMidiConstants.REGULAR_CHANNELS, GeneralMidiConstants.DRUM_CHANNELS));</pre></div>
        
      
        
        <p>We will use the BailErrorStrategy because our compiler is one pass and as soon as a syntax
error occurs the parser may be able to recover but the compilation most likely will not.</p>

        
          <div class='highlight'><pre>        parser.setErrorHandler(<span class="hljs-keyword">new</span> BailErrorStrategy());</pre></div>
        
      
        
        <p>Parse the input!</p>

        
          <div class='highlight'><pre>        parser.song();</pre></div>
        
      
        
        <p>Return the sequence generated while parsing.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">return</span> parser.getSequence();
    }
}</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
