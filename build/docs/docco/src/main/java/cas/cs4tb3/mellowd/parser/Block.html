<!DOCTYPE html>

<html>
<head>
  <title>Block</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="..\..\..\..\..\..\..\docco.css" />
</head>
<body>
<a href="https://github.com/SpencerPark/MellowD"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <div class="toctop" onclick="">
            <a class="source" href="..\..\..\..\..\..\..\index.html">Home</a>
            <h3>Table of Contents</h3>
              
                    
                    <div class="toc" onclick="">
                        <h3>src\main\antlr</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\antlr\MellowDLexer.html">
                                    MellowDLexer.g4
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\antlr\MellowDParser.html">
                                    MellowDParser.g4
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\ArticulatedSound.html">
                                    ArticulatedSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Articulation.html">
                                    Articulation.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Beat.html">
                                    Beat.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Dynamic.html">
                                    Dynamic.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\Pitch.html">
                                    Pitch.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\PlayableSound.html">
                                    PlayableSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\TimingEnvironment.html">
                                    TimingEnvironment.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\compiler</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\compiler\Compiler.html">
                                    Compiler.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\compiler\MIDIIODelegate.html">
                                    MIDIIODelegate.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\compiler\SequenceIODelegate.html">
                                    SequenceIODelegate.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\compiler\SequencePlayer.html">
                                    SequencePlayer.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\compiler\TimeStampedMIDIMessage.html">
                                    TimeStampedMIDIMessage.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\compiler\VirtualMIDIPlayer.html">
                                    VirtualMIDIPlayer.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\compiler\WavIODelegate.html">
                                    WavIODelegate.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\midi</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\GeneralMidiConstants.html">
                                    GeneralMidiConstants.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\GeneralMidiInstrument.html">
                                    GeneralMidiInstrument.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\GeneralMidiPercussion.html">
                                    GeneralMidiPercussion.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\midi\MidiNoteMessageSource.html">
                                    MidiNoteMessageSource.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\parser</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="Block.html">
                                    Block.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="BlockOptions.html">
                                    BlockOptions.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="IncorrectTypeException.html">
                                    IncorrectTypeException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="ParseException.html">
                                    ParseException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="SymbolTable.html">
                                    SymbolTable.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="TrackManager.html">
                                    TrackManager.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="UndefinedReferenceException.html">
                                    UndefinedReferenceException.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\primitives</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Chord.html">
                                    Chord.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Melody.html">
                                    Melody.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Phrase.html">
                                    Phrase.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\primitives\Rhythm.html">
                                    Rhythm.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\ChordResolutionTest.html">
                                    ChordResolutionTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\CompilerTest.html">
                                    CompilerTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\ErrorResponseTest.html">
                                    ErrorResponseTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\ParserTest.html">
                                    ParserTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\java\cas\cs4tb3\mellowd\TestErrorListener.html">
                                    TestErrorListener.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\compilertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\articulation.html">
                                    articulation.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\percussion.html">
                                    percussion.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\strangeChords.html">
                                    strangeChords.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\strangeMelodies.html">
                                    strangeMelodies.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\strangeRhythms.html">
                                    strangeRhythms.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\compilertest\varDeclarations.html">
                                    varDeclarations.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\errortest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\errortest\largeInput.html">
                                    largeInput.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\errortest\largeInputShared.html">
                                    largeInputShared.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\parsertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\parsertest\chordNames.html">
                                    chordNames.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\parsertest\simpleBlock.html">
                                    simpleBlock.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\parsertest\varDeclaration.html">
                                    varDeclaration.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\testdata</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\testdata\CompilerTestData.html">
                                    CompilerTestData.json
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\..\test\resources\testdata\ParserTestData.html">
                                    ParserTestData.json
                                </a>
                            </li>
                        
                        </div>
                    
          </div>
        
            
            <!-- Moved TOC above header -->
            
          
          <h1 id="block">Block</h1>

          
            <div class='highlight'><pre>
<span class="hljs-keyword">package</span> cas.cs4tb3.mellowd.parser;

<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.Articulation;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.Dynamic;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.PlayableSound;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.TimingEnvironment;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.midi.GeneralMidiConstants;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.primitives.Chord;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.primitives.Phrase;
<span class="hljs-keyword">import</span> org.antlr.v4.runtime.Token;

<span class="hljs-keyword">import</span> javax.sound.midi.InvalidMidiDataException;
<span class="hljs-keyword">import</span> javax.sound.midi.MidiEvent;
<span class="hljs-keyword">import</span> javax.sound.midi.ShortMessage;
<span class="hljs-keyword">import</span> javax.sound.midi.Track;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.LinkedList;
<span class="hljs-keyword">import</span> java.util.List;</pre></div>
          
        
      </div>

      
        
        <p>This class is a core element in the compiler. It does a good majority of the actual translation
to MIDI events. It is responsible for keeping its own time so that it knows where to place events
when they are received.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Block</span> </span>{</pre></div>
        
      
        
        <p>This declaration specifies the amount to bend the pitch each glissando step</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> BEND_AMT = <span class="hljs-number">128</span>;</pre></div>
        
      
        
        <p>These are the the longer stateful fields that stay around for
a while. They are mostly used for referencing.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TrackManager trackManager;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TimingEnvironment timingEnv;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Track track;
    <span class="hljs-keyword">private</span> BlockOptions options;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;</pre></div>
        
      
        
        <p>These fields are actively changing and are used for temporary holding
data between adding phrases and sounds.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> time = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> Dynamic dynamic;
    <span class="hljs-keyword">private</span> List&lt;Phrase&gt; dynBuffer = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> cres;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> decres;
    <span class="hljs-keyword">private</span> Token cresToken;</pre></div>
        
      
        
        <p>This data will help with looped compilation units. In order to append events
we need to know at what time the block opened and all the events added since
it was opened. This way when the block is closed we can add all of the events
again.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> loopCount = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> passStartTime = <span class="hljs-number">0L</span>;
    <span class="hljs-keyword">private</span> List&lt;MidiEvent&gt; addedThisPass = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();</pre></div>
        
      
        
        <p>This message need to be delayed by one note so it needs to be stored somewhere
stateful. When a pitch change is made we want to cancel it right before the next
note but at the time the note is received the compiler doesn’t know when the next
note will be so we can hold onto the reset up here.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> ShortMessage queuedPitchReset;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">Block</span><span class="hljs-params">(TrackManager trackManager, TimingEnvironment timingEnv, Track track, BlockOptions options, String name, Dynamic dynamic)</span> </span>{
        <span class="hljs-keyword">this</span>.trackManager = trackManager;
        <span class="hljs-keyword">this</span>.timingEnv = timingEnv;
        <span class="hljs-keyword">this</span>.track = track;
        <span class="hljs-keyword">this</span>.options = options;
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.dynamic = dynamic;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> BlockOptions <span class="hljs-title">getOptions</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.options;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDynamic</span><span class="hljs-params">(Dynamic dynamic)</span> <span class="hljs-keyword">throws</span> InvalidMidiDataException </span>{</pre></div>
        
      
        
        <p>If the block is currently in a decrescendo but the token we just encountered is louder
than the current dynamic the a crescendo is what should have been specified.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.decres &amp;&amp; dynamic.getVelocity() &gt;= <span class="hljs-keyword">this</span>.dynamic.getVelocity())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException(cresToken, <span class="hljs-string">"Decrescendo specified but next volume token ("</span> + dynamic.getVelocity()
                    + <span class="hljs-string">") is the same or louder than the first ("</span> + <span class="hljs-keyword">this</span>.dynamic.getVelocity()
                    + <span class="hljs-string">"). Did you mean crescendo?"</span>);</pre></div>
        
      
        
        <p>If the block is currently in a crescendo but the token we just encountered is quieter
than the current dynamic the a decrescendo is what should have been specified.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cres &amp;&amp; dynamic.getVelocity() &lt;= <span class="hljs-keyword">this</span>.dynamic.getVelocity())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException(cresToken, <span class="hljs-string">"Crescendo specified but next volume token ("</span> + dynamic.getVelocity()
                    + <span class="hljs-string">") is the same or quieter than the first ("</span> + <span class="hljs-keyword">this</span>.dynamic.getVelocity()
                    + <span class="hljs-string">"). Did you mean decrescendo?"</span>);</pre></div>
        
      
        
        <p>If we are currently is a gradual dynamic change then this means all additions
have been queued in the <code>dynBuffer</code> and they need to be compiled now that we
know the target dynamic.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cres || <span class="hljs-keyword">this</span>.decres) {</pre></div>
        
      
        
        <p>First we need to collect all the sounds from all of the queued phrases</p>

        
          <div class='highlight'><pre>            List&lt;PlayableSound&gt; sounds = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();
            <span class="hljs-keyword">for</span> (Phrase buffered : <span class="hljs-keyword">this</span>.dynBuffer) {
                Collections.addAll(sounds, buffered.getSounds());
            }</pre></div>
        
      
        
        <p>Apply the appropriate dynamic to the sounds</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">this</span>.dynamic.graduallyApplyToAllSounds(dynamic, <span class="hljs-keyword">this</span>.timingEnv, sounds);</pre></div>
        
      
        
        <p>Finally add all the sounds to the track</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">for</span> (PlayableSound sound : sounds) {
                addSound(sound);
            }</pre></div>
        
      
        
        <p>Reset everything</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">this</span>.cres = <span class="hljs-keyword">false</span>;
            <span class="hljs-keyword">this</span>.decres = <span class="hljs-keyword">false</span>;
            <span class="hljs-keyword">this</span>.dynBuffer.clear();
        }</pre></div>
        
      
        
        <p>Set the current dynamic state.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">this</span>.dynamic = dynamic;
    }</pre></div>
        
      
        
        <p>The crescendo and decrescendo methods are used to mark the block
as gradually changing velocity. This means that all phrases are held
until the target of the change is specified at the end of the phrases
that the change is applied to.</p>
<p>It requires a token simply for possible error messages later on.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">crescendo</span><span class="hljs-params">(Token cresToken)</span> </span>{
        <span class="hljs-keyword">this</span>.cres = <span class="hljs-keyword">true</span>;
        <span class="hljs-keyword">this</span>.decres = <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">this</span>.cresToken = cresToken;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrescendo</span><span class="hljs-params">(Token decresToken)</span> </span>{
        <span class="hljs-keyword">this</span>.cres = <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">this</span>.decres = <span class="hljs-keyword">true</span>;
        <span class="hljs-keyword">this</span>.cresToken = decresToken;
    }</pre></div>
        
      
        
        <p>This is the entry point for incoming data. Phrases that need to be compiled are
passed into this method.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addPhrase</span><span class="hljs-params">(Phrase phrase)</span> <span class="hljs-keyword">throws</span> InvalidMidiDataException </span>{</pre></div>
        
      
        
        <p>If the block is in a gradual change then the dynamic is not yet known
and the phrase should be queued for later.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cres || <span class="hljs-keyword">this</span>.decres) {</pre></div>
        
      
        
        <p>Queue the phrase</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">this</span>.dynBuffer.add(phrase);
        } <span class="hljs-keyword">else</span> {</pre></div>
        
      
        
        <p>We can compile it now because there is no crescendo or decrescendo happening
so the dynamic is static.</p>

        
          <div class='highlight'><pre>            addPhraseStaticDynamic(phrase);
        }
    }</pre></div>
        
      
        
        <p>This method compiles the phrase using the current dynamic for all sounds
in the phrase.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addPhraseStaticDynamic</span><span class="hljs-params">(Phrase phrase)</span> <span class="hljs-keyword">throws</span> InvalidMidiDataException </span>{
        <span class="hljs-keyword">this</span>.dynamic.applyToAllSounds(phrase.getSounds());
        <span class="hljs-keyword">for</span> (PlayableSound sound : phrase.getSounds()) {
            addSound(sound);
        }
    }</pre></div>
        
      
        
        <p>This method adds loop support for the block. If the block’s loop count
is positive, meaning that the data compiled in this segment will be repeat, then
the event must be saved so it can be repeated when the block closes.</p>

        
      
        
        <p>The event must also be added to the track.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addEventToTrack</span><span class="hljs-params">(MidiEvent event)</span> </span>{
        <span class="hljs-keyword">if</span> (loopCount &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>.addedThisPass.add(event);
        }
        <span class="hljs-keyword">this</span>.track.add(event);
    }</pre></div>
        
      
        
        <p>Here is where the real compilation happens. This method compiles a single sound
including the articulation.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addSound</span><span class="hljs-params">(PlayableSound sound)</span> <span class="hljs-keyword">throws</span> InvalidMidiDataException </span>{</pre></div>
        
      
        
        <p>First things first, we need to add the <code>queuedPitchReset</code> if one exists
so that this sound isn’t bend out of shape.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.queuedPitchReset != <span class="hljs-keyword">null</span>) {
            addEventToTrack(<span class="hljs-keyword">new</span> MidiEvent(<span class="hljs-keyword">this</span>.queuedPitchReset, time-<span class="hljs-number">1</span>));
            <span class="hljs-keyword">this</span>.queuedPitchReset = <span class="hljs-keyword">null</span>;
        }</pre></div>
        
      
        
        <p>The channel is a major part of the MIDI scheduling so it is always left
to the <a href="TrackManager.html">TrackManager</a> to decide on the channel. We will
only ask once per sound because changing channels in the middle of playing
a sound is not possible.</p>

        
          <div class='highlight'><pre>        TrackManager.Channel channel = <span class="hljs-keyword">this</span>.trackManager.getChannel(<span class="hljs-keyword">this</span>);</pre></div>
        
      
        
        <p>The plain sound data is retrieved from the sound. This base data will
then pass through the articulation modifications to tweak it for a more
custom sound.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">long</span> tickDuration = <span class="hljs-keyword">this</span>.timingEnv.ticksInBeat(sound.getDuration());
        <span class="hljs-keyword">if</span> (sound.isSlurred() || sound.getArticulation().equals(Articulation.TENUTO))
            tickDuration += tickDuration/<span class="hljs-number">8</span>;
        <span class="hljs-keyword">int</span> velocity = sound.getVelocity();
        <span class="hljs-keyword">int</span> offVelocity = sound.isSlurred() ? <span class="hljs-number">1</span> : <span class="hljs-number">96</span>;
        <span class="hljs-keyword">boolean</span> roll = <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">long</span> offsetStep = <span class="hljs-number">0</span>;</pre></div>
        
      
        
        <p>Apply the articulation effects</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">switch</span> (sound.getArticulation()) {</pre></div>
        
      
        
        <p>Staccato makes the performance short and choppy. Described in jazz
as <code>dit</code>. To achieve this effect the duration will be chopped to a
third of its value and the note will be ended very quickly.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">case</span> STACCATO:
                tickDuration = tickDuration / <span class="hljs-number">3</span>;
                offVelocity = <span class="hljs-number">127</span>;
                <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>Staccatissimo makes the performance short but more powerful. It is
given some more emphasis. It is similar to staccato but the duration
is going to be chopped to a half (rather than a third) and it will be
played with a bit more velocity.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">case</span> STACCATISSIMO:
                tickDuration = tickDuration / <span class="hljs-number">2</span>;
                velocity = Math.max(<span class="hljs-number">127</span>, velocity + <span class="hljs-number">3</span>);
                offVelocity = <span class="hljs-number">127</span>;
                <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>Marcato is the same a staccato but with more power. It is referred to
as <code>dhat</code> by jazz musicians and to preform a note with articulated with marcato
the note’s duration will be chopped to a third, the velocity will be increased
and the note will be release very quickly.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">case</span> MARCATO:
                tickDuration = tickDuration / <span class="hljs-number">3</span>;
                velocity = Math.max(<span class="hljs-number">127</span>, velocity + <span class="hljs-number">5</span>);
                offVelocity = <span class="hljs-number">127</span>;
                <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>An accent is played by attacking the note. This gives it a much faster velocity and
will also drop off a bit quicker than the average note. This is sometimes referred to
as <code>dah</code> by jazz musicians.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">case</span> ACCENT:
                velocity = Math.max(<span class="hljs-number">127</span>, velocity + <span class="hljs-number">6</span>);
                offVelocity = <span class="hljs-number">113</span>;
                <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>Tenuto is the equivalent of a single note slur. It is also called <code>doo</code> by jazz musicians
and so in order to preform a tenuto note the note will be let off as slow as possible with
a slightly longer duration.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">case</span> TENUTO:
                tickDuration = tickDuration + (tickDuration / <span class="hljs-number">8</span>);
                offVelocity = <span class="hljs-number">1</span>;
                <span class="hljs-keyword">break</span>;</pre></div>
        
      
        
        <p>Gliscando is a glide. It can be preformed as a pitch bend. To preform a gliscando a total of
16 pitch bend changes will give the effect that the note is falling or climbing (depending
on the direction of bend). These changes will be equally spaced over the duration of the note
as to not interfere with the next note. Additionally a reset message will be queued for the
next note to take.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">case</span> GLISCANDO:</pre></div>
        
      
        
        <p>If the sound is a chord a gliscando should be preformed as a roll.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">if</span> (sound.isChord()) {
                    roll = <span class="hljs-keyword">true</span>;</pre></div>
        
      
        
        <p>The roll will play the first note in the chord right on the down beat. Each
consecutive note in the chord will be delayed by the <code>offsetStep</code>.</p>

        
          <div class='highlight'><pre>                    offsetStep = tickDuration / (((Chord) sound.getSound()).size() * <span class="hljs-number">2</span>);</pre></div>
        
      
        
        <p>otherwise preform the gliscando as a pitch bend.</p>

        
          <div class='highlight'><pre>                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">int</span> bendAmt = GeneralMidiConstants.NO_PITCH_BEND;
                    <span class="hljs-keyword">int</span> bendTickOffset;
                    <span class="hljs-keyword">for</span> (bendTickOffset = <span class="hljs-number">0</span>; bendTickOffset &lt; tickDuration; bendTickOffset += tickDuration / <span class="hljs-number">16</span>) {
                        bendAmt += BEND_AMT;
                        ShortMessage message = <span class="hljs-keyword">new</span> ShortMessage(ShortMessage.PITCH_BEND, channel.midiChannelNum, <span class="hljs-number">0x7F</span> &amp; bendAmt, <span class="hljs-number">0x7F</span> &amp; (bendAmt &gt;&gt; <span class="hljs-number">7</span>));
                        addEventToTrack(<span class="hljs-keyword">new</span> MidiEvent(message, time + bendTickOffset));
                    }
                    <span class="hljs-keyword">this</span>.queuedPitchReset = <span class="hljs-keyword">new</span> ShortMessage(ShortMessage.PITCH_BEND, channel.midiChannelNum, <span class="hljs-number">0x7F</span> &amp; GeneralMidiConstants.NO_PITCH_BEND, <span class="hljs-number">0x7F</span> &amp; (GeneralMidiConstants.NO_PITCH_BEND &gt;&gt; <span class="hljs-number">7</span>));
                }
                <span class="hljs-keyword">break</span>;
        }</pre></div>
        
      
        
        <p>Initialize the offset to 0. If <code>!roll</code> then this offset will remain at 0. If
the <code>roll</code> is set to true each time a note is added to the track the next is offset
<code>offsetStep</code>.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">long</span> offset = <span class="hljs-number">0L</span>;</pre></div>
        
      
        
        <p>Now that all of the performance data is set we can create the events and add them to the
track.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">for</span> (ShortMessage message : sound.getSound().noteOn(channel.midiChannelNum, velocity)) {
            addEventToTrack(<span class="hljs-keyword">new</span> MidiEvent(message, <span class="hljs-keyword">this</span>.time + offset));
            <span class="hljs-keyword">if</span> (roll) offset += offsetStep;
        }

        offset = <span class="hljs-number">0</span>;</pre></div>
        
      
        
        <p>The off events will occur after the note completion hence the <code>this.time + tickDuration</code></p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">for</span> (ShortMessage message : sound.getSound().noteOff(channel.midiChannelNum, offVelocity)) {
            addEventToTrack(<span class="hljs-keyword">new</span> MidiEvent(message, <span class="hljs-keyword">this</span>.time + tickDuration + offset));
            <span class="hljs-keyword">if</span> (roll) offset += offsetStep;
        }</pre></div>
        
      
        
        <p>Lastly we need to increase the state time as we just played some music!</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">this</span>.time += <span class="hljs-keyword">this</span>.timingEnv.ticksInBeat(sound.getDuration());
    }</pre></div>
        
      
        
        <p>This method repeats all of the events added in the most recent block fragment</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addLoopedEvents</span><span class="hljs-params">()</span> </span>{</pre></div>
        
      
        
        <p>We need to know the duration of a single pass to properly
update the state time each loop.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">long</span> passDuration = <span class="hljs-keyword">this</span>.time - <span class="hljs-keyword">this</span>.passStartTime;</pre></div>
        
      
        
        <p>For each loop add all of events added in the most recent fragment</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; loopCount; i++) {
            <span class="hljs-keyword">for</span> (MidiEvent event : addedThisPass) {</pre></div>
        
      
        
        <p>The time for the event is going to be the start time relative. To calculate it we will take
the relative start time but subtracting the block fragment’s original start time (<code>passStartTime</code>)
from the event’s time (<code>event.getTick()</code>). Then all that has to be done is shift it up
to the most recent time.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">this</span>.track.add(<span class="hljs-keyword">new</span> MidiEvent(event.getMessage(), event.getTick() - <span class="hljs-keyword">this</span>.passStartTime + <span class="hljs-keyword">this</span>.time));
            }</pre></div>
        
      
        
        <p>Now that we have added an entire loop we can increase the state time accordingly</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">this</span>.time += passDuration;
        }</pre></div>
        
      
        
        <p>Lastly reset the loop data</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">this</span>.loopCount = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.addedThisPass.clear();
    }</pre></div>
        
      
        
        <p>This method should be invoked to notify the block that the options have changed. Some changes require
additional events to be added to the track or other various state changes.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateBlockOptions</span><span class="hljs-params">(Token blockNameToken, BlockOptions options, <span class="hljs-keyword">boolean</span> force)</span> <span class="hljs-keyword">throws</span> InvalidMidiDataException </span>{</pre></div>
        
      
        
        <p>Save the old options for comparing but use the new options when invoking trackmanager methods</p>

        
          <div class='highlight'><pre>        BlockOptions oldOptions = <span class="hljs-keyword">this</span>.options;
        <span class="hljs-keyword">this</span>.options = options;</pre></div>
        
      
        
        <p>If a channel is selected and different from the current channel we will make a request for the
track manager to change to it.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (oldOptions.isChannelSelected() &amp;&amp; oldOptions.getSelectedChannel() != <span class="hljs-keyword">this</span>.options.getSelectedChannel()) {
            String reasonForDenial = <span class="hljs-keyword">this</span>.trackManager.requestChannel(<span class="hljs-keyword">this</span>, oldOptions.getSelectedChannel());
            <span class="hljs-keyword">if</span> (reasonForDenial != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException(blockNameToken, <span class="hljs-string">"Cannot select midi channel "</span>+oldOptions.getSelectedChannel()+<span class="hljs-string">". Reason: "</span>+reasonForDenial);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.trackManager.requestChannel(<span class="hljs-keyword">this</span>);
        }</pre></div>
        
      
        
        <p>Ask the track manager for the channel it is on</p>

        
          <div class='highlight'><pre>        TrackManager.Channel channel = <span class="hljs-keyword">this</span>.trackManager.getChannel(<span class="hljs-keyword">this</span>);</pre></div>
        
      
        
        <p>If the update is forced or the instrument has changed since the last update then
some MIDI program change events need to be added.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (force || oldOptions.getInstrument() != <span class="hljs-keyword">this</span>.options.getInstrument()
                || oldOptions.getSoundbank() != <span class="hljs-keyword">this</span>.options.getSoundbank()) {</pre></div>
        
      
        
        <p>If a soundbank was specified preform the soundbank change sequence described in the
<a href="../midi/GeneralMidiConstants.html">General MIDI Constants</a>.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> (oldOptions.getSoundbank() != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">this</span>.track.add(<span class="hljs-keyword">new</span> MidiEvent(<span class="hljs-keyword">new</span> ShortMessage(ShortMessage.CONTROL_CHANGE, channel.midiChannelNum, GeneralMidiConstants.BANK_SELECT_CC_1, GeneralMidiConstants.BANK_SELECT_CC_1_VAL), time));
                <span class="hljs-keyword">this</span>.track.add(<span class="hljs-keyword">new</span> MidiEvent(<span class="hljs-keyword">new</span> ShortMessage(ShortMessage.CONTROL_CHANGE, channel.midiChannelNum, GeneralMidiConstants.BANK_SELECT_CC_2, oldOptions.getSoundbank()), time));
            }</pre></div>
        
      
        
        <p>Add the program change message</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">this</span>.track.add(<span class="hljs-keyword">new</span> MidiEvent(<span class="hljs-keyword">new</span> ShortMessage(ShortMessage.PROGRAM_CHANGE, channel.midiChannelNum, oldOptions.getInstrument(), <span class="hljs-number">0</span>), time));
        }
    }</pre></div>
        
      
        
        <p>This method is invoked by the compiler when this block in entered.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">enterBlock</span><span class="hljs-params">(Token blockNameToken, BlockOptions options)</span> <span class="hljs-keyword">throws</span> InvalidMidiDataException </span>{</pre></div>
        
      
        
        <p>Update the options because they may have changed.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">this</span>.updateBlockOptions(blockNameToken, options, <span class="hljs-keyword">false</span>);

        <span class="hljs-keyword">if</span> (options.getLoopCount() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>.loopCount = options.getLoopCount();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.loopCount = <span class="hljs-number">0</span>;
        }</pre></div>
        
      
        
        <p>Mark the start time in case we need to loop</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">this</span>.passStartTime = <span class="hljs-keyword">this</span>.time;
    }</pre></div>
        
      
        
        <p>This method is invoked by the compiler when a block is exited.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">leaveBlock</span><span class="hljs-params">()</span> </span>{</pre></div>
        
      
        
        <p>If a loop request was made now is the time to cash in all the newly
added events.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (loopCount &gt; <span class="hljs-number">0</span>) addLoopedEvents();

        MidiEvent endOfTrackEvent = track.get(track.size()-<span class="hljs-number">1</span>);
        endOfTrackEvent.setTick(endOfTrackEvent.getTick() + timingEnv.getPPQ());
    }</pre></div>
        
      
        
        <p>When the song is finished we may need to report some “unclosed” operations like a
crescendo.</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finish</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.dynBuffer.isEmpty())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ParseException(<span class="hljs-keyword">this</span>.cresToken, <span class="hljs-string">"Gradual change specified but found EOF before the target"</span> +
                    <span class="hljs-string">" dynamic is specified."</span>);
    }
}</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
