<!DOCTYPE html>

<html>
<head>
  <title>Compiler Test</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="..\..\..\..\..\..\docco.css" />
</head>
<body>
<a href="https://github.com/SpencerPark/MellowD"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <div class="toctop" onclick="">
            <a class="source" href="..\..\..\..\..\..\index.html">Home</a>
            <h3>Table of Contents</h3>
              
                    
                    <div class="toc" onclick="">
                        <h3>src\main\antlr</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\antlr\MellowDLexer.html">
                                    MellowDLexer.g4
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\antlr\MellowDParser.html">
                                    MellowDParser.g4
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\ArticulatedSound.html">
                                    ArticulatedSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\Articulation.html">
                                    Articulation.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\Beat.html">
                                    Beat.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\Dynamic.html">
                                    Dynamic.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\Pitch.html">
                                    Pitch.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\PlayableSound.html">
                                    PlayableSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\TimingEnvironment.html">
                                    TimingEnvironment.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\compiler</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\compiler\Compiler.html">
                                    Compiler.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\compiler\MIDIIODelegate.html">
                                    MIDIIODelegate.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\compiler\SequenceIODelegate.html">
                                    SequenceIODelegate.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\compiler\SequencePlayer.html">
                                    SequencePlayer.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\compiler\TimeStampedMIDIMessage.html">
                                    TimeStampedMIDIMessage.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\compiler\VirtualMIDIPlayer.html">
                                    VirtualMIDIPlayer.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\compiler\WavIODelegate.html">
                                    WavIODelegate.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\midi</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\midi\GeneralMidiConstants.html">
                                    GeneralMidiConstants.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\midi\GeneralMidiInstrument.html">
                                    GeneralMidiInstrument.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\midi\GeneralMidiPercussion.html">
                                    GeneralMidiPercussion.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\midi\MidiNoteMessageSource.html">
                                    MidiNoteMessageSource.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\parser</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\Block.html">
                                    Block.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\BlockOptions.html">
                                    BlockOptions.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\IncorrectTypeException.html">
                                    IncorrectTypeException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\ParseException.html">
                                    ParseException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\SymbolTable.html">
                                    SymbolTable.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\TrackManager.html">
                                    TrackManager.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\UndefinedReferenceException.html">
                                    UndefinedReferenceException.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\primitives</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\primitives\Chord.html">
                                    Chord.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\primitives\Melody.html">
                                    Melody.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\primitives\Phrase.html">
                                    Phrase.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\primitives\Rhythm.html">
                                    Rhythm.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="ChordResolutionTest.html">
                                    ChordResolutionTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="CompilerTest.html">
                                    CompilerTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="ErrorResponseTest.html">
                                    ErrorResponseTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="ParserTest.html">
                                    ParserTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="TestErrorListener.html">
                                    TestErrorListener.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\compilertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\articulation.html">
                                    articulation.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\percussion.html">
                                    percussion.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\strangeChords.html">
                                    strangeChords.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\strangeMelodies.html">
                                    strangeMelodies.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\strangeRhythms.html">
                                    strangeRhythms.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\varDeclarations.html">
                                    varDeclarations.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\errortest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\errortest\largeInput.html">
                                    largeInput.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\errortest\largeInputShared.html">
                                    largeInputShared.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\parsertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\parsertest\chordNames.html">
                                    chordNames.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\parsertest\simpleBlock.html">
                                    simpleBlock.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\parsertest\varDeclaration.html">
                                    varDeclaration.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\testdata</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\testdata\CompilerTestData.html">
                                    CompilerTestData.json
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\testdata\ParserTestData.html">
                                    ParserTestData.json
                                </a>
                            </li>
                        
                        </div>
                    
          </div>
        
            
            <!-- Moved TOC above header -->
            
          
          <h1 id="compiler-test">Compiler Test</h1>

          
            <div class='highlight'><pre>
<span class="hljs-keyword">package</span> cas.cs4tb3.mellowd;

<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.compiler.Compiler;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.parser.ParseException;
<span class="hljs-keyword">import</span> com.google.gson.Gson;
<span class="hljs-keyword">import</span> com.google.gson.GsonBuilder;
<span class="hljs-keyword">import</span> org.antlr.v4.runtime.RecognitionException;
<span class="hljs-keyword">import</span> org.antlr.v4.runtime.misc.ParseCancellationException;
<span class="hljs-keyword">import</span> org.junit.Test;
<span class="hljs-keyword">import</span> org.junit.runner.RunWith;
<span class="hljs-keyword">import</span> org.junit.runners.Parameterized;

<span class="hljs-keyword">import</span> javax.sound.midi.MidiEvent;
<span class="hljs-keyword">import</span> javax.sound.midi.MidiSystem;
<span class="hljs-keyword">import</span> javax.sound.midi.Sequence;
<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.net.URISyntaxException;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collection;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.Assert.fail;

<span class="hljs-meta">@RunWith</span>(Parameterized.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompilerTest</span> </span>{</pre></div>
          
        
      </div>

      
        
        <p>A class used to teach Gson how to parse the input data. Gson used a reflection
based deserialization strategy to translate from JSON a json description to
a java object. Each field is the name of the JSON object parameter.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompilerTestData</span> </span>{
        <span class="hljs-keyword">public</span> String compFileName;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span> timeNumerator;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span> timeDenominator;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> tempo;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> File OUTDIR = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"compTestOut"</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AtomicInteger TEST_NUM = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">0</span>);</pre></div>
        
      
        
        <h2 id="test-data-loader">Test Data Loader</h2>
<p>Read the test data input configuration and build a test instance for each
case described in the file. Each <code>Object[]</code> is a set of constructor arguments
that will be used to create a new <code>CompilerTest</code> instance who’s <a href="#test-case">compileTest()</a>
will be invoked.</p>

        
          <div class='highlight'><pre>    <span class="hljs-meta">@Parameterized</span>.Parameters(name = <span class="hljs-string">"{index}: {0}"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Collection&lt;Object[]&gt; loadTests() <span class="hljs-keyword">throws</span> IOException {
        BufferedReader reader = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="hljs-string">"testdata/CompilerTestData.json"</span>)));
        Gson gson = <span class="hljs-keyword">new</span> GsonBuilder().create();
        CompilerTestData[] data = gson.fromJson(reader, CompilerTestData[].class);
        reader.close();
        List&lt;Object[]&gt; constructorArgs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(data.length);
        <span class="hljs-keyword">for</span> (CompilerTestData testData : data) {
            constructorArgs.add(<span class="hljs-keyword">new</span> Object[]{
                    testData.compFileName,
                    testData.timeNumerator,
                    testData.timeDenominator,
                    testData.tempo
            });
        }
        <span class="hljs-keyword">return</span> constructorArgs;
    }</pre></div>
        
      
        
        <p>Each test will have a file to compile and the time signature and tempo to compile it
with. The <code>outFile</code> will be a file of the same name inside the <code>compTestOut</code> directory.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> File outFile;
    <span class="hljs-keyword">private</span> File toCompile;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span> timeNumerator;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span> timeDenominator;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> tempo;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CompilerTest</span><span class="hljs-params">(String toCompName, <span class="hljs-keyword">byte</span> timeNumerator, <span class="hljs-keyword">byte</span> timeDenominator, <span class="hljs-keyword">int</span> tempo)</span> <span class="hljs-keyword">throws</span> URISyntaxException </span>{
        <span class="hljs-keyword">this</span>.timeNumerator = timeNumerator;
        <span class="hljs-keyword">this</span>.timeDenominator = timeDenominator;
        <span class="hljs-keyword">this</span>.tempo = tempo;
        String toCompPath = Thread.currentThread().getContextClassLoader().getResource(<span class="hljs-string">"compilertest"</span> + File.separator + toCompName).toURI().getPath();
        <span class="hljs-keyword">this</span>.toCompile = <span class="hljs-keyword">new</span> File(toCompPath);
        <span class="hljs-keyword">this</span>.outFile = <span class="hljs-keyword">new</span> File(toCompile.getParentFile(), OUTDIR + File.separator + toCompile.getName().replace(Compiler.FILE_EXTENSION, <span class="hljs-string">".mid"</span>));
        <span class="hljs-keyword">if</span> (!outFile.getParentFile().exists())
            outFile.getParentFile().mkdirs();
    }</pre></div>
        
      
        
        <h2 id="test-case">Test Case</h2>

        
          <div class='highlight'><pre>    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">compileTest</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">try</span> {</pre></div>
        
      
        
        <p>Print out some information about the test. This includes a marker ID which is simply
a number that uniquely identifies a test from this set. It also displays some test
parameters.</p>

        
          <div class='highlight'><pre>            System.out.printf(<span class="hljs-string">"Compiler Test %d: InFile=%s  OutFile=%s  Tempo=%d TimSig=%d/%d\n"</span>,
                    TEST_NUM.getAndIncrement(), <span class="hljs-keyword">this</span>.toCompile.getName(), <span class="hljs-keyword">this</span>.outFile.getName(),
                    <span class="hljs-keyword">this</span>.tempo, <span class="hljs-keyword">this</span>.timeNumerator, <span class="hljs-keyword">this</span>.timeDenominator);
            System.out.print(<span class="hljs-string">"-----------------------------------------------------------------------------------\n"</span>);
            Sequence compilationResult = Compiler.compile(toCompile, timeNumerator, timeDenominator, tempo, <span class="hljs-keyword">false</span>);
            writeOut(compilationResult);
            System.out.println();
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
            fail(<span class="hljs-string">"IOException encountered while compiling. "</span>+e.getLocalizedMessage());
        } <span class="hljs-keyword">catch</span> (ParseCancellationException e) {
            RecognitionException ex = (RecognitionException) e.getCause();
            fail(String.format(<span class="hljs-string">"Parse exception in rule %s. Offending token: line %d@%d:'%s'. Expected: %s\n"</span>,
                    ex.getCtx().toString(ex.getRecognizer()),
                    ex.getOffendingToken().getLine(),
                    ex.getOffendingToken().getCharPositionInLine(),
                    ex.getOffendingToken().getText(),
                    ex.getExpectedTokens().toString(ex.getRecognizer().getVocabulary())));
        } <span class="hljs-keyword">catch</span> (ParseException e) {
            fail(String.format(<span class="hljs-string">"Compilation exception. %s"</span>, e.getMessage()));
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeOut</span><span class="hljs-params">(Sequence compilationResult)</span> <span class="hljs-keyword">throws</span> IOException </span>{</pre></div>
        
      
        
        <p>Create the output file if it doesn’t exist.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!outFile.exists()) {
            outFile.getParentFile().mkdirs();
            outFile.createNewFile();
        }</pre></div>
        
      
        
        <p>If the compilation result is empty then add the EOT_MESSAGE to make the track playable</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> (compilationResult.getTickLength() == <span class="hljs-number">0</span>) {
            compilationResult.getTracks()[<span class="hljs-number">0</span>].add(<span class="hljs-keyword">new</span> MidiEvent(Compiler.EOT_MESSAGE, <span class="hljs-number">1</span>));
        }</pre></div>
        
      
        
        <p>Write the result to the out file. The type 1 midi format is the standard
type for multi track sequences which we have in our case.</p>

        
          <div class='highlight'><pre>        OutputStream outStream = <span class="hljs-keyword">new</span> FileOutputStream(outFile);
        MidiSystem.write(compilationResult, <span class="hljs-number">1</span>, outStream);
        outStream.close();
        System.out.println(<span class="hljs-string">"Compilation successful."</span>);
    }
}</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
