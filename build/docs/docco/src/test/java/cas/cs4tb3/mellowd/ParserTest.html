<!DOCTYPE html>

<html>
<head>
  <title>Parser Test</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="..\..\..\..\..\..\docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <div class="toctop" onclick="">
            <a class="source" href="..\..\..\..\..\..\index.html">Home</a>
            <h3>Table of Contents</h3>
              
                    
                    <div class="toc" onclick="">
                        <h3>src\main\antlr</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\antlr\MellowDLexer.html">
                                    MellowDLexer.g4
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\antlr\MellowDParser.html">
                                    MellowDParser.g4
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\ArticulatedSound.html">
                                    ArticulatedSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\Articulation.html">
                                    Articulation.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\Beat.html">
                                    Beat.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\Dynamic.html">
                                    Dynamic.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\Pitch.html">
                                    Pitch.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\PlayableSound.html">
                                    PlayableSound.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\TimingEnvironment.html">
                                    TimingEnvironment.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\compiler</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\compiler\Compiler.html">
                                    Compiler.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\compiler\SequencePlayer.html">
                                    SequencePlayer.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\midi</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\midi\GeneralMidiConstants.html">
                                    GeneralMidiConstants.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\midi\GeneralMidiInstrument.html">
                                    GeneralMidiInstrument.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\midi\GeneralMidiPercussion.html">
                                    GeneralMidiPercussion.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\midi\MidiNoteMessageSource.html">
                                    MidiNoteMessageSource.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\parser</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\Block.html">
                                    Block.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\BlockOptions.html">
                                    BlockOptions.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\IncorrectTypeException.html">
                                    IncorrectTypeException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\ParseException.html">
                                    ParseException.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\SymbolTable.html">
                                    SymbolTable.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\TrackManager.html">
                                    TrackManager.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\parser\UndefinedReferenceException.html">
                                    UndefinedReferenceException.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\main\java\cas\cs4tb3\mellowd\primitives</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\primitives\Chord.html">
                                    Chord.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\primitives\Melody.html">
                                    Melody.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\primitives\Phrase.html">
                                    Phrase.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\..\main\java\cas\cs4tb3\mellowd\primitives\Rhythm.html">
                                    Rhythm.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\java\cas\cs4tb3\mellowd</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="ChordResolutionTest.html">
                                    ChordResolutionTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="CompilerTest.html">
                                    CompilerTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="ParserTest.html">
                                    ParserTest.java
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="TestErrorListener.html">
                                    TestErrorListener.java
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\compilertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\articulation.html">
                                    articulation.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\percussion.html">
                                    percussion.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\strangeChords.html">
                                    strangeChords.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\strangeMelodies.html">
                                    strangeMelodies.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\strangeRhythms.html">
                                    strangeRhythms.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\compilertest\varDeclarations.html">
                                    varDeclarations.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\parsertest</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\parsertest\chordNames.html">
                                    chordNames.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\parsertest\simpleBlock.html">
                                    simpleBlock.mlod
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\parsertest\varDeclaration.html">
                                    varDeclaration.mlod
                                </a>
                            </li>
                        
                        </div>
                    
                    <div class="toc" onclick="">
                        <h3>src\test\resources\testdata</h3>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\testdata\CompilerTestData.html">
                                    CompilerTestData.json
                                </a>
                            </li>
                        
                            <li class="tocelem">
                                <a class="source" href="..\..\..\..\resources\testdata\ParserTestData.html">
                                    ParserTestData.json
                                </a>
                            </li>
                        
                        </div>
                    
          </div>
        
            
            <!-- Moved TOC above header -->
            
          
          <h1 id="parser-test">Parser Test</h1>

          
            <div class='highlight'><pre>
<span class="hljs-keyword">package</span> cas.cs4tb3.mellowd;</pre></div>
          
        
      </div>

      
        
        <p>Declare all of the required imports. Gson is the test configuration parser
that will be used in combination with some of the java.io classes. This class
will also need some antlr v4 runtime classes for passing the test data into
the lexer and parser. We also need to import the test classes to run the test
via junit.</p>

        
          <div class='highlight'><pre><span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.midi.GeneralMidiConstants;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.parser.MellowDLexer;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.parser.MellowDParser;
<span class="hljs-keyword">import</span> cas.cs4tb3.mellowd.parser.TrackManager;
<span class="hljs-keyword">import</span> com.google.gson.Gson;
<span class="hljs-keyword">import</span> com.google.gson.GsonBuilder;
<span class="hljs-keyword">import</span> org.antlr.v4.runtime.ANTLRInputStream;
<span class="hljs-keyword">import</span> org.antlr.v4.runtime.CommonTokenStream;
<span class="hljs-keyword">import</span> org.antlr.v4.runtime.ParserRuleContext;
<span class="hljs-keyword">import</span> org.junit.Test;
<span class="hljs-keyword">import</span> org.junit.runner.RunWith;
<span class="hljs-keyword">import</span> org.junit.runners.Parameterized;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.Collection;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.Assert.fail;</pre></div>
        
      
        
        <p>This test will use the Parameterized runner. This is a JUnit runner that executes
all tests in this class for each test input data returned by <a href="#test-data-loader">loadTests()</a>.</p>

        
          <div class='highlight'><pre><span class="hljs-meta">@RunWith</span>(Parameterized.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParserTest</span> </span>{</pre></div>
        
      
        
        <p>This AtomicInteger will track the test number. It is a thread-safe integer that
we can keep increasing for each test to give each test an id.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AtomicInteger TEST_NUM = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">0</span>);</pre></div>
        
      
        
        <h2 id="test-data-loader">Test Data Loader</h2>
<p>Read the test data input configuration and build a test instance for each
case described in the file. Each <code>Object[]</code> is a set of constructor arguments
that will be used to create a new <code>ParserTest</code> instance who’s <a href="#test-case">parseTest()</a>
will be invoked.</p>

        
          <div class='highlight'><pre>    <span class="hljs-meta">@Parameterized</span>.Parameters(name = <span class="hljs-string">"{index}: {1}"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Collection&lt;Object[]&gt; loadTests() <span class="hljs-keyword">throws</span> IOException {
        BufferedReader reader = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="hljs-string">"testdata/ParserTestData.json"</span>)));
        Gson gson = <span class="hljs-keyword">new</span> GsonBuilder().create();
        Object[][] data = gson.fromJson(reader, String[][].class);
        reader.close();
        <span class="hljs-keyword">return</span> Arrays.asList(data);
    }</pre></div>
        
      
        
        <p>Declare some fields specific to each test run. We need to track the test info
<code>inputFileName</code> and <code>ruleName</code>. We also need to hold onto the <code>inputStream</code> so
we can close it at the end of the test. The <code>parser</code> is the instance that the
test is being run on and our <code>errorListener</code> will track some more detailed
information about what is going on during the test.</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">private</span> MellowDParser parser;
    <span class="hljs-keyword">private</span> TestErrorListener errorListener;
    <span class="hljs-keyword">private</span> String inputFileName;
    <span class="hljs-keyword">private</span> String ruleName;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> amt;
    <span class="hljs-keyword">private</span> InputStream inputStream;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ParserTest</span><span class="hljs-params">(String inputFile, String ruleName, String amt)</span> <span class="hljs-keyword">throws</span> IOException </span>{</pre></div>
        
      
        
        <p>Get the test resource and save a reference to it so it may be closed
upon completion of the test.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">this</span>.inputStream = Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="hljs-string">"parsertest"</span> + File.separator + inputFile);</pre></div>
        
      
        
        <p>Instantiate the lexer and parser. The parser’s default error listener
needs to be overridden with a custom one to store all error messages.</p>

        
          <div class='highlight'><pre>        MellowDLexer lexer = <span class="hljs-keyword">new</span> MellowDLexer(<span class="hljs-keyword">new</span> ANTLRInputStream(<span class="hljs-keyword">this</span>.inputStream));

        <span class="hljs-keyword">this</span>.parser = <span class="hljs-keyword">new</span> MellowDParser(<span class="hljs-keyword">new</span> CommonTokenStream(lexer), <span class="hljs-keyword">new</span> TimingEnvironment((<span class="hljs-keyword">byte</span>) <span class="hljs-number">4</span>, (<span class="hljs-keyword">byte</span>) <span class="hljs-number">4</span>, <span class="hljs-number">120</span>),
                <span class="hljs-keyword">new</span> TrackManager(GeneralMidiConstants.REGULAR_CHANNELS, GeneralMidiConstants.DRUM_CHANNELS));
        <span class="hljs-keyword">this</span>.parser.setBuildParseTree(<span class="hljs-keyword">true</span>);
        <span class="hljs-keyword">this</span>.parser.removeErrorListeners();
        <span class="hljs-keyword">this</span>.errorListener = <span class="hljs-keyword">new</span> TestErrorListener();
        <span class="hljs-keyword">this</span>.parser.addErrorListener(<span class="hljs-keyword">this</span>.errorListener);
        <span class="hljs-keyword">this</span>.inputFileName = inputFile;
        <span class="hljs-keyword">this</span>.ruleName = ruleName;
        <span class="hljs-keyword">this</span>.amt = Integer.parseInt(amt);
    }</pre></div>
        
      
        
        <h2 id="test-case">Test Case</h2>
<p>Try and parse the input file starting at the given start rule.</p>

        
          <div class='highlight'><pre>    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">try</span> {
            Method ruleMethod = parser.getClass().getMethod(ruleName);</pre></div>
        
      
        
        <p>Print out some information about the test. This includes a marker ID which is simply
a number that uniquely identifies a test from this set. It also displays the target
starting rule and the name of the input file used.</p>

        
          <div class='highlight'><pre>            System.out.println(<span class="hljs-string">"Parser Test "</span> + TEST_NUM.getAndIncrement() + <span class="hljs-string">": Rule="</span> + <span class="hljs-keyword">this</span>.ruleName
                    + <span class="hljs-string">" InFile="</span> + <span class="hljs-keyword">this</span>.inputFileName);
            System.out.print(<span class="hljs-string">"-----------------------------------------------------------------------------------\n"</span>);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> runNum = <span class="hljs-number">0</span>; runNum &lt; <span class="hljs-keyword">this</span>.amt; runNum++) {
                System.out.printf(<span class="hljs-string">"Run: %d\n\t"</span>, runNum);
                ParserRuleContext context = (ParserRuleContext) ruleMethod.invoke(parser);</pre></div>
        
      
        
        <p>Check for a failed parse.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.errorListener.encounteredError()) {</pre></div>
        
      
        
        <p>Print out more detailed information about the failure.</p>

        
          <div class='highlight'><pre>                    System.out.println(<span class="hljs-string">"FAILED: Errors encountered while parsing."</span>);
                    <span class="hljs-keyword">for</span> (String error : <span class="hljs-keyword">this</span>.errorListener.getErrors()) {
                        System.out.print(<span class="hljs-string">"\t\t"</span>);
                        System.out.println(error);
                    }
                    fail(<span class="hljs-string">"Exceptions thrown while parsing. See standard output for more detail."</span>);
                }</pre></div>
        
      
        
        <p>If we reach this part in the test code the test has passed so we will
print out some information about the data parsed. This includes the matched rule,
the starting token, the final token and the parse tree.</p>

        
          <div class='highlight'><pre>                System.out.println(context.toInfoString(<span class="hljs-keyword">this</span>.parser));
                System.out.println();
            }</pre></div>
        
      
        
        <p>No matter how the test goes we must close the input stream.</p>

        
          <div class='highlight'><pre>        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">this</span>.inputStream.close();
        }
    }
}</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
